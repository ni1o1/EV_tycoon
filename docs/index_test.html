<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>EV Tycoon: Strategy Edition v1.4 (Level System Update) - Test Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        /* ç¦ç”¨åŒå‡»ç¼©æ”¾ï¼Œä½†ä¿ç•™æ­£å¸¸çš„æ»‘åŠ¨å’Œå•æŒ‡ç‚¹å‡» */
button, 
.game-container {
    touch-action: manipulation;
}

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", sans-serif;
            background-color: #f1f5f9; 
            color: #0f172a;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none;
            height: 100vh; /* Fallback */
            height: 100dvh; /* Mobile Fix */
            display: flex;
            flex-direction: column;
        }
        
        .scrollable-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #canvas-wrapper {
            width: 100%;
            flex: 1; 
            min-height: 300px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 15px -3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 1px solid #e2e8f0;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* å›¾è¡¨å®¹å™¨æ ·å¼ */
        #chart-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 28%; 
            z-index: 10;
            pointer-events: none; 
        }

        canvas { 
            width: 100%;
            height: 100%;
            display: block;
        }

        .control-panel {
            background: #fff;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
            border-top: 1px solid #e2e8f0;
            padding: 8px 12px; 
            flex-shrink: 0;
            z-index: 50;
            padding-bottom: env(safe-area-inset-bottom, 12px);
        }

        .stat-card { 
            background: #fff; 
            padding: 4px; 
            border-radius: 6px; 
            border: 1px solid #cbd5e1;
            text-align: center; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 48px;
            position: relative;
        }

        .btn { 
            transition: all 0.1s; 
            position: relative; 
            touch-action: manipulation;
        }
        .btn:active { transform: scale(0.96); }
        .btn:disabled { opacity: 0.5; filter: grayscale(100%); cursor: not-allowed; }

        .float-text {
            position: absolute;
            font-weight: 800;
            font-size: 14px;
            pointer-events: none;
            animation: floatUp 1.2s ease-out forwards;
            z-index: 50;
            text-shadow: 1px 1px 0 #fff, -1px -1px 0 #fff;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(0.8); opacity: 0; }
            20% { transform: translateY(-20px) scale(1.2); opacity: 1; }
            100% { transform: translateY(-50px) scale(1); opacity: 0; }
        }

        .power-bar-container {
            width: 100%; height: 6px; background-color: #e2e8f0; 
            border-radius: 3px; overflow: hidden; display: flex; position: relative;
        }
        .scale-line {
            position: absolute; top: 0; bottom: 0; width: 1px;
            background-color: rgba(255,255,255,0.8); z-index: 10;
        }
        .power-segment { height: 100%; transition: width 0.3s ease-out; }
        .warning-pulse { animation: pulseRed 1s infinite; }
        @keyframes pulseRed {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            100% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
        }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%;
            background: #2563eb; margin-top: -7px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #cbd5e1; border-radius: 2px;
        }

        .option-card.selected {
            border-color: #2563eb;
            background-color: #eff6ff;
            color: #1e40af;
        }

        .original-price {
            text-decoration: line-through;
            color: #94a3b8;
            font-size: 8px;
            margin-right: 2px;
        }
        .discount-price {
            color: #16a34a;
            font-weight: bold;
        }
        
        .realtime-profit {
            font-size: 9px;
            font-weight: bold;
            margin-left: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .realtime-profit.show { opacity: 1; }
        .profit-plus { color: #16a34a; }
        .profit-minus { color: #ef4444; }

        /* 3D æŒ‰é’®ç‰¹æ•ˆ */
        .btn-3d {
            position: relative;
            border-bottom-width: 3px; /* åº•éƒ¨è¾¹æ¡†æ¨¡æ‹Ÿåšåº¦ */
            transition: all 0.1s;
            top: 0;
        }
        .btn-3d:active {
            border-bottom-width: 0px; /* æŒ‰ä¸‹æ—¶è¾¹æ¡†æ¶ˆå¤± */
            top: 3px; /* æ•´ä½“ä¸‹ç§»ï¼Œæ¨¡æ‹Ÿè¢«æŒ‰è¿›å»äº† */
        }
        .btn-3d:disabled {
            opacity: 0.6;
            filter: grayscale(100%);
            cursor: not-allowed;
            border-bottom-width: 0;
            top: 3px;
            background-color: #e2e8f0;
            color: #94a3b8;
            border-color: transparent;
        }
    </style>
</head>
<body>

    <!-- æ¸¸æˆä¸»ç•Œé¢å®¹å™¨ - åœ¨é€‰æ‹©å…³å¡å‰éšè— -->
    <div id="game-main-container" class="hidden">
        <div class="scrollable-content">
        <!-- ç¬¬ä¸€è¡Œ -->
        <div class="flex gap-2 shrink-0">
            <div class="w-1/3 stat-card border-t-4 border-green-500 relative overflow-hidden">
                <div class="flex items-center justify-between w-full px-1">
                    <span class="text-[10px] text-gray-400 font-bold uppercase">èµ„é‡‘</span>
                    <!-- è´·æ¬¾æŒ‰é’® -->
                    <button onclick="openLoanModal()" class="px-2 py-0.5 flex items-center justify-center bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-[10px] font-bold shadow-sm active:scale-95 transition-transform" title="é“¶è¡Œè´·æ¬¾">ğŸ¦ è´·æ¬¾</button>
                </div>
                <div class="flex items-baseline justify-center w-full">
                    <div class="text-base font-mono text-green-700 font-bold leading-none mb-0.5" id="ui-money">$3500.00</div>
                </div>
                <!-- å®æ—¶åˆ©æ¶¦è·³åŠ¨ -->
                <div class="absolute top-6 right-1" id="ui-tick-profit"></div>
                
                <div class="text-[9px] text-gray-400 font-medium" id="ui-last-profit">æ˜¨æ—¥: --</div>
            </div>
            
            <div class="w-2/3 stat-card border-t-4 border-blue-500 flex flex-row justify-between items-center px-4">
                <div class="flex flex-col items-start">
                    <div class="text-2xl font-mono leading-none text-slate-800 font-bold mb-1" id="ui-clock">08:00</div>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] bg-slate-100 px-1.5 py-0.5 rounded text-slate-600 font-bold" id="ui-day">D1</span>
                        <span class="text-[9px] text-slate-400 font-bold uppercase tracking-wider" id="ui-speed-label">PAUSED</span>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                     <span class="text-3xl leading-none" id="ui-weather-icon">â˜€ï¸</span>
                     <div class="flex flex-col items-end min-w-[36px]">
                        <span class="text-[9px] font-bold text-slate-500 whitespace-nowrap" id="ui-weather-eff">100%</span>
                        <span class="text-[9px] text-slate-400 whitespace-nowrap mt-0.5 border-t border-slate-200 pt-0.5 font-medium" id="ui-forecast">æ˜:â˜€ï¸</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¬¬äºŒè¡Œï¼šæ”¹ä¸º 4 åˆ—ä»¥å®¹çº³è´·æ¬¾ä¿¡æ¯ -->
        <div class="grid grid-cols-4 gap-2 shrink-0">
            <div class="stat-card border-t-4 border-purple-500">
                <span class="text-[8px] text-gray-400 font-bold uppercase scale-90">å®¢æµ</span>
                <div class="text-sm font-bold text-purple-600 leading-tight" id="ui-pool">15</div>
            </div>
            <div class="stat-card border-t-4 border-orange-400">
                <span class="text-[8px] text-gray-400 font-bold uppercase scale-90">æ—¥æˆæœ¬</span>
                <span class="text-xs font-bold font-mono" id="ui-daily-cost">-$7.5</span>
            </div>
            <!-- æ–°å¢ï¼šè¿˜è´·ä¿¡æ¯å¡ç‰‡ -->
            <div class="stat-card border-t-4 border-indigo-500 bg-indigo-50/50" id="card-loan-status" onclick="openLoanModal()">
                <span class="text-[8px] text-indigo-400 font-bold uppercase scale-90">ä»Šæ—¥è¿˜æ¬¾</span>
                <span class="text-xs font-bold font-mono text-indigo-600" id="ui-loan-payment">--</span>
            </div>
            <div class="stat-card border-t-4 border-red-500">
                <div class="flex items-center justify-center gap-0.5">
                    <span class="text-[8px] text-gray-400 font-bold uppercase scale-90">å‘¨ç§Ÿ</span>
                    <span class="text-[7px] bg-red-100 text-red-500 px-0.5 rounded" id="ui-rent-countdown">6d</span>
                </div>
                <span class="text-xs font-bold text-red-600 font-mono" id="ui-weekly-rent">-$500</span>
            </div>
        </div>

        <!-- Buff Bar -->
        <div id="ui-buff-bar" class="hidden w-full flex gap-2 overflow-x-auto pb-1 min-h-[24px]"></div>

        <!-- Canvas Area -->
        <div id="canvas-wrapper">
            <div id="power-monitor" class="absolute top-2 left-2 right-2 bg-white/95 backdrop-blur rounded p-2 border border-slate-200 shadow-sm pointer-events-none transition-colors duration-300 z-10" style="display: none;">
                <div class="flex justify-between text-[10px] mb-1 font-bold text-slate-600 items-center">
                    <span id="ui-load-label">å®æ—¶åŠŸç‡</span>
                    <span id="ui-load-text" class="font-mono text-xs">0.0 / 20 kW</span>
                </div>
                <div class="power-bar-container">
                    <div class="scale-line" style="left: 25%"></div><div class="scale-line" style="left: 50%"></div><div class="scale-line" style="left: 75%"></div>
                    <div id="bar-solar" class="power-segment bg-yellow-400 flex items-center justify-center text-[8px] font-bold text-yellow-800" style="width:0%"></div>
                    <div id="bar-batt" class="power-segment bg-green-500 flex items-center justify-center text-[8px] font-bold text-white" style="width:0%"></div>
                    <div id="bar-grid" class="power-segment bg-blue-500" style="width:0%"></div>
                </div>
                <div id="ui-overload-msg" class="hidden text-[10px] text-red-600 font-bold text-center mt-1 animate-pulse bg-red-50 rounded">
                    âš ï¸ ç”µç½‘è¿‡è½½ï¼å……ç”µé€Ÿåº¦ä¸‹é™
                </div>
            </div>

            <!-- å›¾è¡¨å®¹å™¨ï¼šç»å¯¹å®šä½åœ¨åº•éƒ¨ -->
            <div id="chart-container">
                <!-- åŸç”Ÿ HTML è¿‡è½½æ ‡ç­¾ï¼Œæ›¿ä»£ ECharts Graphic -->
                <div id="chart-overload-label" class="hidden absolute top-0 right-2 bg-red-50 border border-red-400 text-red-600 text-[9px] font-bold px-2 py-0.5 rounded shadow-sm z-20 flex items-center gap-1 backdrop-blur-sm">
                    <span class="animate-pulse">âš ï¸</span> <span>ç”µç½‘è¿‡è½½</span>
                </div>
                <div id="chart-batt-status" class="hidden absolute top-0 left-2 bg-green-50 border border-green-400 text-green-700 text-[9px] font-bold px-2 py-0.5 rounded shadow-sm z-20 flex items-center gap-1 backdrop-blur-sm">
                    <span>ğŸ”‹</span> <span id="batt-status-text">å……ç”µä¸­</span>
                </div>
            </div>

            <canvas id="gameCanvas"></canvas>
            <div id="fx-container" class="absolute top-0 left-0 w-full h-full pointer-events-none overflow-hidden"></div>
        </div>
    </div>

    <!-- Controls -->
    <div class="control-panel flex flex-col gap-2">
        <div class="flex gap-2">
            <div class="flex flex-col justify-between w-1/3">
                <div class="text-[10px] text-slate-400 font-bold mb-1">ç”µç½‘æˆæœ¬: <span id="ui-grid-price" class="text-slate-700 text-sm">$0.40</span></div>
                <div class="text-[10px] text-slate-400 font-bold mb-1">æ¸¸æˆé€Ÿåº¦: </div>
                <div class="flex bg-slate-100 p-1 rounded-lg gap-0.5">
                     <button onclick="setSpeed(0)" class="speed-btn flex-1 py-1 rounded text-[10px] font-bold text-slate-500" id="speed-0">â¸</button>
                     <button onclick="setSpeed(500)" class="speed-btn flex-1 py-1 rounded text-[10px] font-bold bg-white text-blue-600 shadow-sm" id="speed-1">1x</button>
                     <button onclick="setSpeed(125)" class="speed-btn flex-1 py-1 rounded text-[10px] font-bold text-slate-500" id="speed-4">4x</button>
                     <button onclick="setSpeed(62.5)" class="speed-btn flex-1 py-1 rounded text-[10px] font-bold text-slate-500" id="speed-8">8x</button>
                </div>
            </div>

<div class="bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-200 flex-1 flex flex-col justify-center">
    <div class="flex justify-between mb-1 items-end">
        <label class="text-[10px] font-bold text-slate-500">é”€å”®ç”µä»·</label>
        <span id="price-display" class="font-mono font-bold text-blue-600 text-lg leading-none">$1.50</span>
    </div>
    
    <div class="flex items-center gap-2">
        <button onclick="adjustPrice(-0.1)" class="w-8 h-8 flex items-center justify-center bg-white border border-slate-300 rounded-full shadow-sm active:scale-95 text-slate-600 font-bold text-lg leading-none touch-manipulation">
            -
        </button>
        
        <div class="flex-1 relative h-6 flex items-center">
            <input type="range" id="price-slider" min="0.5" max="3.0" step="0.1" value="1.5" oninput="updatePrice(this.value)" class="relative z-10">
            </div>

        <button onclick="adjustPrice(0.1)" class="w-8 h-8 flex items-center justify-center bg-white border border-slate-300 rounded-full shadow-sm active:scale-95 text-blue-600 font-bold text-lg leading-none touch-manipulation">
            +
        </button>
    </div>
    <div class="flex justify-between text-[8px] text-slate-400 mt-1 font-medium px-1">
        <span>$0.5</span><span>$1.5</span><span>$3.0</span>
    </div>
</div>
        </div>

        <!-- å‹ç¼©çš„æŒ‰é’®ç½‘æ ¼ï¼šé«˜åº¦å‡å°‘ï¼Œå­—ä½“å¾®è°ƒ -->
<div class="grid grid-cols-3 gap-2">
    
    <button id="btn-slow" onclick="buyAsset('slowCharger')" class="btn-3d bg-blue-100 border-blue-300 text-blue-900 rounded-lg px-2 py-1 flex flex-col justify-between h-[54px]">
        <div class="flex justify-between items-baseline w-full">
            <span class="font-bold text-[11px]">æ…¢å……</span>
            <span class="text-[9px] opacity-60">7kW</span>
        </div>
        <div class="flex justify-between items-end w-full">
            <div class="flex flex-col items-start leading-none gap-0.5">
                <span class="text-[10px] font-bold font-mono" id="cost-slow">$600</span>
                <span class="text-[8px] font-medium transform scale-95 origin-left">ç»´æŠ¤$10/æ—¥</span>
            </div>
            <span class="text-[9px] bg-white/60 px-1.5 py-0.5 rounded text-blue-800 font-bold leading-none shadow-sm mb-0.5" id="count-slow">1</span>
        </div>
    </button>

    <button id="btn-fast" onclick="buyAsset('fastCharger')" class="btn-3d bg-purple-100 border-purple-300 text-purple-900 rounded-lg px-2 py-1 flex flex-col justify-between h-[54px]">
        <div class="flex justify-between items-baseline w-full">
            <span class="font-bold text-[11px]">å¿«å……</span>
            <span class="text-[9px] opacity-60">30kW</span>
        </div>
        <div class="flex justify-between items-end w-full">
            <div class="flex flex-col items-start leading-none gap-0.5">
                <span class="text-[10px] font-bold font-mono" id="cost-fast">$1200</span>
                <span class="text-[8px] font-medium transform scale-95 origin-left">ç»´æŠ¤$20/æ—¥</span>
            </div>
            <span class="text-[9px] bg-white/60 px-1.5 py-0.5 rounded text-purple-800 font-bold leading-none shadow-sm mb-0.5" id="count-fast">0</span>
        </div>
    </button>

    <button onclick="buyAsset('transformer')" class="btn-3d bg-slate-100 border-slate-300 text-slate-700 rounded-lg px-2 py-1 flex flex-col justify-between h-[54px]">
        <div class="flex justify-between items-baseline w-full">
            <span class="font-bold text-[11px]">é…ç”µ</span>
            <span class="text-[9px] opacity-60" id="transformer-sub">+20kW</span>
        </div>
        <div class="flex justify-between items-end w-full">
            <div class="flex flex-col items-start leading-none gap-0.5">
                <span class="text-[10px] font-bold font-mono" id="cost-transformer">$600</span>
                <span class="text-[8px] font-medium transform scale-95 origin-left">ç»´æŠ¤$10/æ—¥</span>
            </div>
            <span class="text-[9px] bg-white/60 px-1.5 py-0.5 rounded text-slate-600 font-bold leading-none shadow-sm mb-0.5" id="count-transformer">0</span>
        </div>
    </button>

    <button onclick="buyAsset('solar')" class="btn-3d bg-orange-100 border-orange-300 text-orange-900 rounded-lg px-2 py-1 flex flex-col justify-between h-[54px]">
        <div class="flex justify-between items-baseline w-full">
            <span class="font-bold text-[11px]">å…‰ä¼</span>
            <span class="text-[9px] opacity-60">10kW</span>
        </div>
        <div class="flex justify-between items-end w-full">
            <div class="flex flex-col items-start leading-none gap-0.5">
                <span class="text-[10px] font-bold font-mono" id="cost-solar">$600</span>
                <span class="text-[8px] font-medium transform scale-95 origin-left">ç»´æŠ¤$10/æ—¥</span>
            </div>
            <span class="text-[9px] bg-white/60 px-1.5 py-0.5 rounded text-orange-800 font-bold leading-none shadow-sm mb-0.5" id="count-solar">0</span>
        </div>
    </button>

    <button onclick="buyAsset('battery')" class="btn-3d bg-emerald-100 border-emerald-300 text-emerald-900 rounded-lg px-2 py-1 flex flex-col justify-between h-[54px]">
        <div class="flex justify-between items-baseline w-full">
            <span class="font-bold text-[11px]">å‚¨èƒ½</span>
            <span class="text-[9px] opacity-60">100kWh</span>
        </div>
        <div class="flex justify-between items-end w-full">
            <div class="flex flex-col items-start leading-none gap-0.5">
                <span class="text-[10px] font-bold font-mono" id="cost-battery">$600</span>
                <span class="text-[8px] font-medium transform scale-95 origin-left">ç»´æŠ¤$10/æ—¥</span>
            </div>
            <span class="text-[9px] bg-white/60 px-1.5 py-0.5 rounded text-emerald-800 font-bold leading-none shadow-sm mb-0.5" id="count-battery">0</span>
        </div>
    </button>

    <button onclick="buyAsset('marketing')" class="btn-3d bg-pink-100 border-pink-300 text-pink-900 rounded-lg px-2 py-1 flex flex-col justify-between h-[54px]">
        <div class="flex justify-between items-baseline w-full">
            <span class="font-bold text-[11px]">æ¨å¹¿</span>
            <span class="text-[9px] opacity-60"></span>
        </div>
        <div class="flex justify-between items-end w-full">
            <div class="flex flex-col items-start leading-none gap-0.5">
                <span class="text-[10px] font-bold font-mono" id="cost-marketing">$1500</span>
                <span class="text-[8px] text-pink-700 font-medium transform scale-95 origin-left">å¢åŠ æœ€å¤§å®¢æµ</span>
            </div>
            <span class="text-[9px] bg-white/60 px-1.5 py-0.5 rounded text-pink-800 font-bold leading-none shadow-sm mb-0.5">+10äºº</span>
        </div>
    </button>
</div>
        </div>
    </div>
    </div>

    <!-- Modals -->
    <!-- å…³å¡é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="level-select-modal" class="fixed inset-0 z-60 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm overflow-y-auto">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
            <h1 class="text-3xl font-black text-slate-800 mb-2 text-center">âš¡ EVå¤§äº¨</h1>
            <p class="text-sm text-slate-600 text-center mb-6">é€‰æ‹©å…³å¡æŒ‘æˆ˜</p>

            <div class="space-y-3">
                <!-- å…³å¡1ï¼šæ–°æ‰‹èµ·æ­¥ -->
                <div onclick="selectLevel(1)" class="level-card border-2 border-green-200 bg-green-50 rounded-xl p-4 cursor-pointer hover:shadow-lg transition-all">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-bold text-green-900">ğŸ† å…³å¡1ï¼šæ–°æ‰‹èµ·æ­¥</h3>
                            <p class="text-sm text-green-700 mt-1">éšè—é«˜çº§åŠŸèƒ½ï¼Œå­˜æ´»40å¤©</p>
                            <div class="flex gap-2 mt-2">
                                <span class="text-xs bg-green-200 text-green-800 px-2 py-1 rounded">éšè—å¿«å……</span>
                                <span class="text-xs bg-green-200 text-green-800 px-2 py-1 rounded">éšè—å…‰ä¼</span>
                                <span class="text-xs bg-green-200 text-green-800 px-2 py-1 rounded">éšè—å‚¨èƒ½</span>
                                <span class="text-xs bg-green-200 text-green-800 px-2 py-1 rounded">éšè—è´·æ¬¾</span>
                            </div>
                        </div>
                        <div class="text-2xl">ğŸŒŸ</div>
                    </div>
                </div>

                <!-- å…³å¡2ï¼šæ ‡å‡†æŒ‘æˆ˜ -->
                <div onclick="selectLevel(2)" class="level-card border-2 border-blue-200 bg-blue-50 rounded-xl p-4 cursor-pointer hover:shadow-lg transition-all">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-bold text-blue-900">ğŸ† å…³å¡2ï¼šæ ‡å‡†æŒ‘æˆ˜</h3>
                            <p class="text-sm text-blue-700 mt-1">æ ‡å‡†æ¨¡å¼ï¼Œå­˜æ´»100å¤©</p>
                            <div class="flex gap-2 mt-2">
                                <span class="text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded">æ ‡å‡†æ¨¡å¼</span>
                                <span class="text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded">å®Œæ•´åŠŸèƒ½</span>
                            </div>
                        </div>
                        <div class="text-2xl">ğŸ“ˆ</div>
                    </div>
                </div>

                <!-- å…³å¡3ï¼šè¶…å……ç‹‚çƒ­ -->
                <div onclick="selectLevel(3)" class="level-card border-2 border-yellow-200 bg-yellow-50 rounded-xl p-4 cursor-pointer hover:shadow-lg transition-all">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-bold text-yellow-900">ğŸ† å…³å¡3ï¼šè¶…å……ç‹‚çƒ­</h3>
                            <p class="text-sm text-yellow-700 mt-1">åªèƒ½ä½¿ç”¨å¿«å……ï¼Œç¦ç”¨æ…¢å……</p>
                            <div class="flex gap-2 mt-2">
                                <span class="text-xs bg-yellow-200 text-yellow-800 px-2 py-1 rounded">ç¦ç”¨æ…¢å……</span>
                                <span class="text-xs bg-yellow-200 text-yellow-800 px-2 py-1 rounded">å¿«å……ç­–ç•¥</span>
                            </div>
                        </div>
                        <div class="text-2xl">âš¡</div>
                    </div>
                </div>

                <!-- å…³å¡4ï¼šç¦»ç½‘æŒ‘æˆ˜ -->
                <div onclick="selectLevel(4)" class="level-card border-2 border-purple-200 bg-purple-50 rounded-xl p-4 cursor-pointer hover:shadow-lg transition-all">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-bold text-purple-900">ğŸ† å…³å¡4ï¼šç¦»ç½‘æŒ‘æˆ˜</h3>
                            <p class="text-sm text-purple-700 mt-1">åªèƒ½ä½¿ç”¨å…‰ä¼å’Œå‚¨èƒ½</p>
                            <div class="flex gap-2 mt-2">
                                <span class="text-xs bg-purple-200 text-purple-800 px-2 py-1 rounded">ç¦ç”¨ç”µç½‘</span>
                                <span class="text-xs bg-purple-200 text-purple-800 px-2 py-1 rounded">å…‰ä¼å‚¨èƒ½</span>
                            </div>
                        </div>
                        <div class="text-2xl">ğŸ”‹</div>
                    </div>
                </div>

                <!-- è‡ªç”±å®šä¹‰æ¨¡å¼ -->
                <div onclick="selectLevel(0)" class="level-card border-2 border-slate-300 bg-slate-100 rounded-xl p-4 cursor-pointer hover:shadow-lg transition-all">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-bold text-slate-900">ğŸ® è‡ªç”±å®šä¹‰æ¨¡å¼</h3>
                            <p class="text-sm text-slate-600 mt-1">è‡ªå®šä¹‰æ‰€æœ‰è®¾ç½®ï¼ŒæŒ‘æˆ˜å„ç§å›°éš¾</p>
                            <div class="flex gap-2 mt-2">
                                <span class="text-xs bg-slate-200 text-slate-800 px-2 py-1 rounded">è‡ªå®šä¹‰</span>
                                <span class="text-xs bg-slate-200 text-slate-800 px-2 py-1 rounded">é«˜çº§</span>
                            </div>
                        </div>
                        <div class="text-2xl">âš™ï¸</div>
                    </div>
                </div>
            </div>

            <div class="mt-6 text-center">
                <p class="text-xs text-slate-500">é€‰æ‹©å…³å¡åå¼€å§‹ä½ çš„å……ç”µç«™ç»è¥ä¹‹æ—…ï¼</p>
            </div>
        </div>
    </div>

    <!-- åŸèµ·å§‹æ¨¡æ€æ¡† -->
    <div id="start-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm overflow-y-auto">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 max-h-[90vh] overflow-y-auto">
            <h1 class="text-2xl font-black text-slate-800 mb-4 text-center">âš¡ å……ç”µç«™é€‰å€è§„åˆ’</h1>

            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                <p class="text-sm text-blue-800 text-center leading-relaxed">
                    ğŸª <strong>ç»è¥ä½ çš„å……ç”µç«™</strong> - è´­ä¹°è®¾å¤‡ã€è®¾ç½®ç”µä»·ã€èµšå–åˆ©æ¶¦<br>
                    âš¡ å¹³è¡¡<strong>å…‰ä¼</strong>ã€<strong>å‚¨èƒ½</strong>å’Œ<strong>ç”µç½‘</strong>ï¼Œåº”å¯¹åˆ†æ—¶ç”µä»·<br>
                    ğŸ¯ ç›®æ ‡ï¼šåœ¨100å¤©å†…ä¿æŒç›ˆåˆ©ï¼Œæˆä¸ºå……ç”µç«™å¤§äº¨ï¼
                </p>
            </div>
            
<div class="mb-4">
    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">é€‰æ‹©åŸå¸‚ (åˆ†æ—¶ç”µä»·éš¾åº¦)</label>
    <div class="grid grid-cols-3 gap-2">
        <div onclick="selectOption('city', 'sh')" class="option-card city-card border rounded-lg p-2 text-center cursor-pointer selected" data-val="sh">
            <div class="text-sm font-bold text-slate-700">ä¸Šæµ·</div>
            <div class="text-[9px] text-green-600 font-bold">ğŸŸ¢ ç®€å•</div>
        </div>

        <div onclick="selectOption('city', 'gz')" class="option-card city-card border rounded-lg p-2 text-center cursor-pointer" data-val="gz">
            <div class="text-sm font-bold text-slate-700">å¹¿å·</div>
            <div class="text-[9px] text-yellow-600 font-bold">ğŸŸ¡ æ™®é€š</div>
        </div>

        <div onclick="selectOption('city', 'bj')" class="option-card city-card border rounded-lg p-2 text-center cursor-pointer" data-val="bj">
            <div class="text-sm font-bold text-slate-700">åŒ—äº¬</div>
            <div class="text-[9px] text-red-500 font-bold">ğŸ”´ å›°éš¾</div>
        </div>
    </div>
    <p id="city-desc" class="text-xs text-slate-400 mt-1">ä¸­é—´æ—¶æ®µç”µä»·å¹³ç¨³ï¼Œé€‚åˆæ–°æ‰‹ä¸Šæ‰‹ã€‚</p>
</div>

<div class="mb-4">
    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">é€‰æ‹©åœ°æ®µ (å½±å“å®¢æµæ¨¡å¼)</label>
    <div class="grid grid-cols-3 gap-2">
        <div onclick="selectOption('loc', 'ind')" class="option-card loc-card border rounded-lg p-2 text-center cursor-pointer selected" data-val="ind">
            <div class="text-sm font-bold text-slate-700">å°±ä¸šä¸­å¿ƒ</div>
            <div class="text-[9px] text-green-600 font-bold">ğŸŸ¢ ç®€å•</div>
        </div>

        <div onclick="selectOption('loc', 'com')" class="option-card loc-card border rounded-lg p-2 text-center cursor-pointer" data-val="com">
            <div class="text-sm font-bold text-slate-700">å•†ä¸šåŒº</div>
            <div class="text-[9px] text-yellow-600 font-bold">ğŸŸ¡ æ™®é€š</div>
        </div>

        <div onclick="selectOption('loc', 'res')" class="option-card loc-card border rounded-lg p-2 text-center cursor-pointer" data-val="res">
            <div class="text-sm font-bold text-slate-700">å±…æ°‘åŒº</div>
            <div class="text-[9px] text-red-500 font-bold">ğŸ”´ å›°éš¾</div>
        </div>
    </div>
    <p id="loc-desc" class="text-xs text-slate-400 mt-1">ç™½å¤©äººå¤šï¼Œå®Œç¾å¥‘åˆå…‰ä¼å‘ç”µã€‚</p>
</div>
<div class="mb-6">
    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">ç»è¥æŒ‘æˆ˜</label>
    
    <div class="grid grid-cols-2 gap-2">
        
        <div onclick="selectOption('mode', 'std')" class="option-card mode-card border rounded-lg p-2 cursor-pointer selected flex justify-between items-center h-full" data-val="std">
            <div class="overflow-hidden"><span class="block text-sm font-bold text-slate-800 truncate">æ ‡å‡†æ¨¡å¼</span><span class="block text-[10px] text-slate-400 leading-tight">å¹³è¡¡ä½“éªŒ</span></div><span class="text-lg ml-1">ğŸ¢</span>
        </div>

        <div onclick="selectOption('mode', 'super')" class="option-card mode-card border rounded-lg p-2 cursor-pointer flex justify-between items-center h-full" data-val="super">
            <div class="overflow-hidden"><span class="block text-sm font-bold text-slate-800 truncate">è¶…å……ç‹‚çƒ­</span><span class="block text-[10px] text-slate-400 leading-tight">ç¦ä¹°æ…¢å……</span></div><span class="text-lg ml-1">âš¡</span>
        </div>

        <div onclick="selectOption('mode', 'offgrid')" class="option-card mode-card border rounded-lg p-2 cursor-pointer flex justify-between items-center h-full" data-val="offgrid">
            <div class="overflow-hidden"><span class="block text-sm font-bold text-slate-800 truncate">ç¦»ç½‘æŒ‘æˆ˜</span><span class="block text-[10px] text-slate-400 leading-tight">ä»…ç”¨å…‰å‚¨</span></div><span class="text-lg ml-1">ğŸ”‹</span>
        </div>

        <div onclick="selectOption('mode', 'ghost')" class="option-card mode-card border rounded-lg p-2 cursor-pointer flex justify-between items-center h-full" data-val="ghost">
            <div class="overflow-hidden"><span class="block text-sm font-bold text-slate-800 truncate">é¬¼åŸå±æœº</span><span class="block text-[10px] text-slate-400 leading-tight">å®¢æµå‡åŠ</span></div><span class="text-lg ml-1">ğŸ‘»</span>
        </div>

        <div onclick="selectOption('mode', 'luxury')" class="option-card mode-card border rounded-lg p-2 cursor-pointer flex justify-between items-center h-full" data-val="luxury">
            <div class="overflow-hidden"><span class="block text-sm font-bold text-slate-800 truncate">è±ªååœ°æ®µ</span><span class="block text-[10px] text-slate-400 leading-tight">ç§Ÿé‡‘æ˜‚è´µ</span></div><span class="text-lg ml-1">ğŸ’</span>
        </div>

        <div onclick="selectOption('mode', 'powerlimit')" class="option-card mode-card border rounded-lg p-2 cursor-pointer flex justify-between items-center h-full" data-val="powerlimit">
            <div class="overflow-hidden"><span class="block text-sm font-bold text-slate-800 truncate">é™ç”µæ¨¡å¼</span><span class="block text-[10px] text-slate-400 leading-tight">å®¹æ˜“è¿‡è½½</span></div><span class="text-lg ml-1">âš¡</span>
        </div>
        
        <div onclick="selectOption('mode', 'inflation')" class="option-card mode-card border rounded-lg p-2 cursor-pointer flex justify-between items-center border-red-200 bg-red-50 h-full" data-val="inflation">
            <div class="overflow-hidden"><span class="block text-sm font-bold text-red-900 truncate">æ¶æ€§é€šèƒ€</span><span class="block text-[10px] text-red-600 leading-tight">ä»·æ ¼æš´æ¶¨</span></div><span class="text-lg ml-1">ğŸ“ˆ</span>
        </div>

        <div onclick="selectOption('mode', 'rain')" class="option-card mode-card border rounded-lg p-2 cursor-pointer flex justify-between items-center border-blue-200 bg-blue-50 h-full" data-val="rain">
            <div class="overflow-hidden"><span class="block text-sm font-bold text-blue-900 truncate">æ°¸æ’é›¨å­£</span><span class="block text-[10px] text-blue-600 leading-tight">å…‰ä¼å¤±æ•ˆ</span></div><span class="text-lg ml-1">â›ˆï¸</span>
        </div>
        
        <div onclick="selectOption('mode', 'shark')" class="col-span-2 option-card mode-card border rounded-lg p-2 cursor-pointer flex justify-between items-center border-slate-200 bg-slate-100 h-full" data-val="shark">
            <div><span class="block text-sm font-bold text-slate-900">é«˜åˆ©è´·</span><span class="text-[10px] text-slate-600">æ¯3å¤©äº¤é«˜é¢ç§Ÿé‡‘</span></div><span class="text-lg">ğŸ©¸</span>
        </div>
    </div>
</div>

            <button onclick="startGame()" class="w-full py-3.5 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 active:scale-95 transition">
                å¼€å§‹è¥ä¸š (ç›®æ ‡ï¼šå­˜æ´»100å¤©)
            </button>
        </div>
    </div>

    <!-- Loan Modal -->
    <div id="loan-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-slate-800">ğŸ¦ é“¶è¡Œè´·æ¬¾</h2>
                <div class="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded font-mono">æ—¥åˆ©ç‡ 8.0%</div>
            </div>

            <!-- è´·æ¬¾ç”³è¯·è¡¨å• -->
            <div id="loan-form">
                <div class="mb-4">
                    <div class="flex justify-between text-xs font-bold text-slate-600 mb-2">
                        <span>è´·æ¬¾é‡‘é¢</span>
                        <span id="loan-amt-val" class="text-blue-600">$1500</span>
                    </div>
                    <input type="range" id="loan-amt-slider" min="500" max="2000" step="100" value="1500" oninput="updateLoanPreview()" class="w-full">
                </div>

                <div class="mb-4">
                    <div class="flex justify-between text-xs font-bold text-slate-600 mb-2">
                        <span>è´·æ¬¾æ—¶é•¿</span>
                        <span id="loan-days-val" class="text-blue-600">10å¤©</span>
                    </div>
                    <input type="range" id="loan-days-slider" min="3" max="15" step="1" value="15" oninput="updateLoanPreview()" class="w-full">
                </div>

                <div class="mb-6">
                    <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">è¿˜æ¬¾æ–¹å¼</label>
                    <div class="grid grid-cols-2 gap-2">
                        <div onclick="setLoanType('installment')" id="btn-installment" class="border-2 border-blue-500 bg-blue-50 text-blue-700 rounded-lg p-2 text-center cursor-pointer transition-colors">
                            <div class="text-xs font-bold">ç­‰é¢æœ¬æ¯</div>
                            <div class="text-[9px] opacity-75">æ¯æ—¥å®šé¢è¿˜æ¬¾</div>
                        </div>
                        <div onclick="setLoanType('principal')" id="btn-principal" class="border border-slate-200 text-slate-600 rounded-lg p-2 text-center cursor-pointer transition-colors">
                            <div class="text-xs font-bold">ç­‰é¢æœ¬é‡‘</div>
                            <div class="text-[9px] opacity-75">é¦–æ—¥å¤šï¼Œé€æ—¥å‡</div>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-50 p-3 rounded-xl border border-slate-200 mb-4 text-sm space-y-1">
                    <div class="flex justify-between">
                        <span class="text-slate-500 text-xs">æ€»è¿˜æ¬¾é¢</span>
                        <span class="font-bold text-slate-800" id="loan-total-repay">$5750</span>
                    </div>
                    <div class="flex justify-between items-center pt-1 border-t border-slate-100 mt-1">
                        <span class="text-slate-500 text-xs">é¦–æ—¥éœ€è¿˜</span>
                        <span class="font-bold font-mono text-red-600" id="loan-daily-repay">$575.00</span>
                    </div>
                </div>

                <div class="flex gap-2">
                    <button onclick="closeLoanModal()" class="flex-1 py-2.5 bg-slate-100 text-slate-600 font-bold rounded-xl">å–æ¶ˆ</button>
                    <button onclick="takeLoan()" class="flex-1 py-2.5 bg-blue-600 text-white font-bold rounded-xl shadow hover:bg-blue-700">ç”³è¯·è´·æ¬¾</button>
                </div>
            </div>

            <!-- ç°æœ‰è´·æ¬¾çŠ¶æ€ -->
            <div id="loan-status-view" class="hidden">
                <div class="bg-blue-50 border border-blue-100 p-4 rounded-xl text-center mb-6">
                    <div class="text-xs text-blue-500 font-bold mb-1">å‰©ä½™æœ¬é‡‘</div>
                    <div class="text-3xl font-mono font-bold text-blue-700 mb-2" id="status-principal">$3000</div>
                    <div class="text-[10px] text-blue-400">å‰©ä½™æœŸé™: <span id="status-days" class="font-bold text-blue-600">5</span> å¤©</div>
                </div>
                <div class="text-xs text-slate-400 text-center mb-6">
                    å½“å‰æœ‰æœªç»“æ¸…è´·æ¬¾ï¼Œæ— æ³•ç”³è¯·æ–°è´·æ¬¾ã€‚<br>ç³»ç»Ÿå°†æ¯æ—¥è‡ªåŠ¨æ‰£é™¤è¿˜æ¬¾é¢ã€‚
                </div>
                <button onclick="closeLoanModal()" class="w-full py-3 bg-slate-200 text-slate-600 font-bold rounded-xl">å…³é—­</button>
            </div>
        </div>
    </div>

    <div id="event-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center">
            <div class="text-5xl mb-3" id="ev-icon">ğŸ“¢</div>
            <h2 class="text-xl font-bold text-slate-800 mb-2" id="ev-title">çªå‘äº‹ä»¶</h2>
            <div class="bg-slate-50 p-4 rounded-xl text-left border border-slate-100 mb-4">
                <div class="text-sm text-slate-600 mb-2 leading-relaxed" id="ev-desc">...</div>
                <div class="flex justify-between items-center border-t border-slate-200 pt-2 mt-2">
                    <span class="text-xs text-slate-400">è´¢åŠ¡å½±å“</span>
                    <span class="font-bold font-mono text-lg" id="ev-amt">$0</span>
                </div>
            </div>
            <button onclick="closeEventModal()" class="w-full py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg">ç¡®è®¤</button>
        </div>
    </div>

    <div id="bill-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center">
            <div class="text-5xl mb-3">ğŸ§¾</div>
            <h2 class="text-xl font-bold text-slate-800 mb-4">å‘¨ç»“ç®—è´¦å•</h2>
            <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 mb-6 space-y-2 text-sm">
                <div class="flex justify-between">
                    <span>å½“å‰ä½™é¢</span><span class="font-mono text-slate-600" id="bill-balance">...</span>
                </div>
                <div class="flex justify-between text-red-500">
                    <span>æœ¬å‘¨ç§Ÿé‡‘</span><span class="font-mono font-bold" id="bill-rent">...</span>
                </div>
                <div class="border-t border-slate-200 my-2"></div>
                <div class="flex justify-between font-bold text-base text-slate-800">
                    <span>ç»“ä½™</span><span class="font-mono" id="bill-final">...</span>
                </div>
            </div>
            <button onclick="payBill()" class="w-full py-3.5 bg-red-600 text-white font-bold rounded-xl shadow-lg hover:bg-red-700">æ”¯ä»˜è´¦å•</button>
        </div>
    </div>

    <div id="game-over-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-8 text-center">
            <div id="go-icon" class="text-6xl mb-2">ğŸ’€</div>
            <h1 class="text-3xl font-black mb-2" id="go-title">ç ´äº§æ¸…ç®—</h1>
            <p class="text-slate-500 mb-6 text-sm" id="go-desc">èµ„é‡‘é“¾æ–­è£‚ã€‚</p>
            <div class="bg-slate-100 p-4 rounded-xl mb-6">
                <p class="text-xs text-slate-400 uppercase font-bold">å­˜æ´»å¤©æ•°</p>
                <p class="text-4xl font-black text-slate-800" id="final-days">0</p>
            </div>
            <div class="flex flex-col gap-2">
                <button id="btn-continue" onclick="continueGame()" class="hidden w-full py-3 bg-blue-600 text-white font-bold rounded-xl active:scale-95 transition">ç»§ç»­è¿è¥</button>
                <button onclick="restartGame()" class="w-full py-3 bg-slate-900 text-white font-bold rounded-xl active:scale-95 transition">é‡æ–°å¼€å§‹</button>
            </div>
        </div>
    </div>

<script>

    document.addEventListener('touchstart', function (event) {
    if (event.touches.length > 1) {
        event.preventDefault(); // é˜»æ­¢å¤šæŒ‡ç¼©æ”¾
    }
}, { passive: false });

// ================= é…ç½®æ•°æ® =================
// æ—¥åˆ©ç‡ 2% (0.02)ã€‚ä½ å¯ä»¥æ ¹æ®éš¾åº¦è°ƒæ•´ï¼Œæ¯”å¦‚ç®€å•0.01ï¼Œå›°éš¾0.03
const LOAN_DAILY_RATE = 0.08;
const CITY_CONFIG = {
    bj: { name: "åŒ—äº¬", prices: [0.35, 0.35, 0.35, 0.35, 0.35, 0.35, 0.35, 0.75, 0.75, 0.75, 1.50, 1.50, 1.50, 0.75, 0.75, 0.75, 0.75, 1.50, 1.50, 1.50, 1.50, 1.50, 0.75, 0.35] },
    gz: { name: "å¹¿å·", prices: [0.35, 0.35, 0.35, 0.35, 0.35, 0.35, 0.35, 0.35, 0.75, 0.75, 1.50, 1.50, 0.75, 0.75, 1.50, 1.50, 1.50, 1.50, 1.50, 0.75, 0.75, 0.75, 0.75, 0.75] },
    sh: { name: "ä¸Šæµ·", prices: [0.35, 0.35, 0.35, 0.35, 0.35, 0.35, 0.75, 0.75, 1.50, 1.50, 1.50, 0.75, 0.75, 0.75, 0.75, 0.75, 0.75, 0.75, 1.50, 1.50, 1.50, 0.75, 0.35, 0.35] }
};

const LOC_CONFIG = {
    res: { name: "å±…æ°‘åŒº", traffic: [0.3, 0.2, 0.1, 0.1, 0.1, 0.2, 0.4, 0.5, 0.3, 0.2, 0.1, 0.1, 0.1, 0.1, 0.2, 0.3, 0.6, 0.8, 0.9, 1.0, 0.9, 0.7, 0.5, 0.4] }, 
    com: { name: "å•†ä¸šåŒº", traffic: [0.05, 0.05, 0.0, 0.0, 0.0, 0.0, 0.1, 0.2, 0.4, 0.6, 0.8, 0.9, 0.8, 0.7, 0.7, 0.6, 0.7, 0.9, 1.0, 1.0, 0.9, 0.6, 0.3, 0.1] }, 
    ind: { name: "å°±ä¸šä¸­å¿ƒ", traffic: [0.05, 0.05, 0.05, 0.05, 0.1, 0.2, 0.5, 0.9, 1.0, 0.8, 0.6, 0.5, 0.5, 0.5, 0.4, 0.3, 0.2, 0.1, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05] } 
};

const CONFIG = {
    initialMoney: 3500, 
    dailyCost: { slowCharger: 10, fastCharger: 20, solar: 10, battery: 10, transformer: 10 },
    baseWeeklyRent: 1000,
    rentGrowth: 250, 
    baseCosts: { slowCharger: 600, fastCharger: 1200, solar: 600, battery: 600, transformer: 600, marketing: 1500 },
    inflationRate: 1.10, 
    batteryCap: 100, batteryRate: 20, solarMax: 10, 
    baseLoadLimit: 20, transformerBoost: 20, 
    chargerPower: { slow: 7, fast: 30 },
    baseDailyPool: 15, 
    weather: {
        types: ['sunny', 'cloudy', 'rainy'],
        probs: [0.6, 0.3, 0.2],
        eff: { sunny: 1.0, cloudy: 0.6, rainy: 0.1, foggy: 0.4, stormy: 0.0, snowy: 0.25 },
        icons: { sunny: 'â˜€ï¸', cloudy: 'â˜ï¸', rainy: 'ğŸŒ§ï¸', foggy: 'ğŸŒ«ï¸', stormy: 'â›ˆï¸', snowy: 'â„ï¸' }
    },
    carEmojis: ['ğŸš—', 'ğŸš•', 'ğŸš™', 'ğŸï¸', 'ğŸš“', 'ğŸš‘', 'ğŸš', 'ğŸ›»'],
    targetDays: 100
};

function generateTimeLabels() {
    const labels = [];
    for (let h = 0; h < 24; h++) {
        for (let m = 0; m < 60; m += 10) {
            labels.push(`${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`);
        }
    }
    return labels;
}
const TIME_LABELS = generateTimeLabels();

const weatherSystem = { sunAngle: 0, clouds: [], rainDrops: [], init: false };
function initWeatherSystem(w, h) {
    weatherSystem.clouds = [];
    for(let i=0; i<5; i++) { weatherSystem.clouds.push({ x: Math.random() * w, y: 20 + Math.random() * 60, speed: 0.2 + Math.random() * 0.3, scale: 0.8 + Math.random() * 0.5 }); }
    weatherSystem.rainDrops = [];
    for(let i=0; i<100; i++) { weatherSystem.rainDrops.push({ x: Math.random() * w, y: Math.random() * h, speed: 10 + Math.random() * 10, len: 10 + Math.random() * 15 }); }
    weatherSystem.init = true;
}

// ================= çŠ¶æ€ç®¡ç† =================
let state = getInitialState();
let selectedSettings = { city: 'sh', loc: 'ind', mode: 'std' };
let modalOpenCount = 0;
let myChart = null;
let loanConfig = { type: 'installment' }; // 'installment' (ç­‰é¢æœ¬æ¯) or 'principal' (ç­‰é¢æœ¬é‡‘)
let currentLevel = 0; // å½“å‰é€‰æ‹©çš„å…³å¡
let unlockedLevels = []; // å·²è§£é”çš„å…³å¡

function getInitialState() {
    return {
        money: CONFIG.initialMoney, day: 1, hour: 8, minute: 0, 
        paused: true, gameSpeed: 500, lastGameSpeed: 500,
        assets: { slowCharger: 1, fastCharger: 0, solar: 0, battery: 0, transformer: 0 }, 
        currentCosts: { ...CONFIG.baseCosts },
        batteryKwh: 0, price: 1.5, 
        dailyPoolMax: CONFIG.baseDailyPool, dailyPoolLeft: CONFIG.baseDailyPool,
        cars: [], 
        lastTickData: { load: 0, solar: 0, batt: 0, grid: 0, limit: CONFIG.baseLoadLimit, battAction: 'idle' },
        chartData: { solar: new Array(144).fill(null), battery: new Array(144).fill(null), load: new Array(144).fill(null), yesterdayLoad: new Array(144).fill(null) },
        weeksSurvived: 0,
        nextEventTime: null,
        activeBuffs: [],
        timer: null,
        currentDayProfit: 0, lastDayProfit: null,
        pendingRent: 0,
        weather: rollWeather(),
        forecast: rollWeather(),
        victoryAchieved: false,
        settings: { city: 'bj', loc: 'res', mode: 'std' },
        // æ–°å¢è´·æ¬¾çŠ¶æ€
        loan: { active: false, principal: 0, totalRemaining: 0, daysLeft: 0, type: 'installment', originalDays: 0, originalPrincipal: 0 }
    };
}

// ================= UI & Setup =================

function selectOption(type, val) {
    selectedSettings[type] = val;
    document.querySelectorAll(`.${type}-card`).forEach(el => el.classList.remove('selected'));
    document.querySelector(`.${type}-card[data-val="${val}"]`).classList.add('selected');

    if (type === 'city') {
        const desc = { sh: "ç™½å¤©æœ‰è¶…é•¿å¹³ä»·æœŸ(11-18ç‚¹)ï¼Œå®¹é”™ç‡é«˜ï¼Œé€‚åˆå…‰ä¼ã€‚", gz: "ä¸‹åˆ(14-19ç‚¹)ç”µä»·æé«˜ï¼Œå•†ä¸šåŒºæ…é€‰ï¼æ™šä¸Šè¾ƒä¾¿å®œã€‚", bj: "æ™šé«˜å³°(17-22ç‚¹)ç”µä»·æè´µä¸”é•¿ï¼Œå±…æ°‘åŒºå¿…é¡»é…å‚¨èƒ½ï¼" };
        const descEl = document.getElementById('city-desc');
        descEl.innerText = desc[val];
        if(val === 'sh') descEl.className = "text-xs text-green-600 mt-1 font-bold";
        else if(val === 'bj') descEl.className = "text-xs text-red-500 mt-1 font-bold";
        else descEl.className = "text-xs text-slate-400 mt-1";
    } else if (type === 'loc') {
        const desc = { res: "æ™šé—´éœ€æ±‚å¤§", com: "ç™½æ—¥éœ€æ±‚å¤§", ind: "æ—©æ™šåŒé«˜å³°" };
        document.getElementById('loc-desc').innerText = desc[val];
    }
}

function selectLevel(level) {
    // æ£€æŸ¥å…³å¡æ˜¯å¦å·²è§£é”
    if (level > 0 && !isLevelUnlocked(level)) {
        alert('è¯·å…ˆé€šè¿‡å‰é¢çš„å…³å¡ï¼');
        return;
    }

    currentLevel = level;
    document.querySelectorAll('.level-card').forEach(el => el.classList.remove('border-slate-900', 'shadow-lg'));
    event.currentTarget.classList.add('border-slate-900', 'shadow-lg');

    setTimeout(() => {
        if (level === 0) {
            // è‡ªç”±å®šä¹‰æ¨¡å¼ï¼Œæ‰“å¼€åŸèµ·å§‹é¡µ
            closeModal('level-select-modal');
            openModal('start-modal');
        } else {
            // é¢„è®¾å…³å¡æ¨¡å¼
            closeModal('level-select-modal');
            startLevelGame(level);
        }
    }, 300);
}

function startLevelGame(level) {
    // æ˜¾ç¤ºæ¸¸æˆä¸»ç•Œé¢
    document.getElementById('game-main-container').classList.remove('hidden');

    // æ ¹æ®å…³å¡è®¾ç½®æ¸¸æˆå‚æ•°
    if (level === 1) {
        // å…³å¡1ï¼šæ–°æ‰‹èµ·æ­¥
        state = getInitialState();
        state.settings = { city: 'sh', loc: 'ind', mode: 'std' };
        state.targetDays = 40; // ç›®æ ‡å­˜æ´»40å¤©
        state.levelName = 'æ–°æ‰‹èµ·æ­¥';

        // éšè—é«˜çº§åŠŸèƒ½æŒ‰é’®
        setTimeout(() => {
            const btnFast = document.getElementById('btn-fast');
            const btnSolar = document.getElementById('btn-solar');
            const btnBattery = document.getElementById('btn-battery');
            const btnLoan = document.getElementById('btn-loan');

            if (btnFast) btnFast.style.display = 'none';
            if (btnSolar) btnFast.style.display = 'none';
            if (btnBattery) btnBattery.style.display = 'none';
            if (btnLoan) btnLoan.style.display = 'none';
        }, 100);
    } else if (level === 2) {
        // å…³å¡2ï¼šæ ‡å‡†æŒ‘æˆ˜
        state = getInitialState();
        state.settings = { city: 'sh', loc: 'ind', mode: 'std' };
        state.targetDays = 100;
        state.levelName = 'æ ‡å‡†æŒ‘æˆ˜';
    } else if (level === 3) {
        // å…³å¡3ï¼šè¶…å……ç‹‚çƒ­
        state = getInitialState();
        state.settings = { city: 'sh', loc: 'com', mode: 'super' };
        state.targetDays = 100;
        state.levelName = 'è¶…å……ç‹‚çƒ­';
    } else if (level === 4) {
        // å…³å¡4ï¼šç¦»ç½‘æŒ‘æˆ˜
        state = getInitialState();
        state.settings = { city: 'sh', loc: 'res', mode: 'offgrid' };
        state.targetDays = 100;
        state.levelName = 'ç¦»ç½‘æŒ‘æˆ˜';

        // é™ä½è®¾å¤‡æˆæœ¬
        for (let key in state.currentCosts) {
            state.currentCosts[key] = Math.floor(state.currentCosts[key] * 0.75);
        }
    }

    // åº”ç”¨å…³å¡è®¾ç½®
    if (state.settings.mode === 'jam') { state.dailyPoolMax = 999; state.dailyPoolLeft = 999; }
    else if (state.settings.mode === 'ghost') { state.dailyPoolMax = 15; state.dailyPoolLeft = 15; }
    else if (state.settings.mode === 'luxury') { state.dailyPoolMax = 40; state.dailyPoolLeft = 40; }
    else if (state.settings.mode === 'powerlimit') { state.dailyPoolMax = CONFIG.baseDailyPool; state.dailyPoolLeft = CONFIG.baseDailyPool; }
    else if (state.settings.mode === 'super') {
        const btnSlow = document.getElementById('btn-slow');
        if (btnSlow) { btnSlow.disabled = true; btnSlow.classList.add('opacity-50'); }
    }

    if (state.settings.mode === 'offgrid') {
        for (let key in state.currentCosts) { state.currentCosts[key] = Math.floor(state.currentCosts[key] * 0.75); }
    }
    if (state.settings.mode === 'rain') {
        state.weather = 'rainy'; state.forecast = 'rainy';
        state.activeBuffs.push({ name: "æ°¸æ’æš´é›¨", type: 'forcedWeather', val: 'rainy', daysLeft: 9999, icon: 'â›ˆï¸' });
    }
    if (state.settings.mode === 'inflation') CONFIG.inflationRate = 1.50; else CONFIG.inflationRate = 1.10;

    const transformerLabel = document.getElementById('transformer-sub');
    if (state.settings.mode === 'powerlimit') transformerLabel.innerText = '+10kW'; else transformerLabel.innerText = '+20kW';

    scheduleNextEvent();
    updateUI();
    initChart();
    resizeCanvas();
    setSpeed(500);
    state.paused = false;
    tick();
}

function startGame() {
    closeModal('start-modal');
    state = getInitialState();
    state.settings = { ...selectedSettings };
    
    if (state.settings.mode === 'jam') { state.dailyPoolMax = 999; state.dailyPoolLeft = 999; }
    else if (state.settings.mode === 'ghost') { state.dailyPoolMax = 15; state.dailyPoolLeft = 15; }
    else if (state.settings.mode === 'luxury') { state.dailyPoolMax = 40; state.dailyPoolLeft = 40; }
    else if (state.settings.mode === 'powerlimit') { state.dailyPoolMax = CONFIG.baseDailyPool; state.dailyPoolLeft = CONFIG.baseDailyPool; }
    else if (state.settings.mode === 'super') {
        const btnSlow = document.getElementById('btn-slow');
        if (btnSlow) { btnSlow.disabled = true; btnSlow.classList.add('opacity-50'); }
    }

    if (state.settings.mode === 'offgrid') {
        for (let key in state.currentCosts) { state.currentCosts[key] = Math.floor(state.currentCosts[key] * 0.75); }
    }
    if (state.settings.mode === 'rain') {
        state.weather = 'rainy'; state.forecast = 'rainy';
        state.activeBuffs.push({ name: "æ°¸æ’æš´é›¨", type: 'forcedWeather', val: 'rainy', daysLeft: 9999, icon: 'â›ˆï¸' });
    }
    if (state.settings.mode === 'inflation') CONFIG.inflationRate = 1.50; else CONFIG.inflationRate = 1.10;

    const transformerLabel = document.getElementById('transformer-sub');
    if (state.settings.mode === 'powerlimit') transformerLabel.innerText = '+10kW'; else transformerLabel.innerText = '+20kW';

    scheduleNextEvent();
    updateUI();
    initChart();
    resizeCanvas();
    setSpeed(500); 
    state.paused = false;
    tick();
}

function initChart() {
    const chartDom = document.getElementById('chart-container');
    if (myChart) myChart.dispose();
    myChart = echarts.init(chartDom);
    const option = {
        backgroundColor: 'rgba(255, 255, 255, 0.7)',
        grid: { left: '5%', right: '5%', bottom: '5%', top: '20%', containLabel: true },
        legend: { data: ['æ˜¨æ—¥', 'å…‰ä¼', 'å‚¨èƒ½', 'ç”µç½‘'], top: 2, textStyle: { color: '#64748b', fontSize: 10 }, itemWidth: 10, itemHeight: 8, icon: 'roundRect' },
        tooltip: { trigger: 'axis' },
        xAxis: { type: 'category', boundaryGap: false, data: TIME_LABELS, axisLine: { show: false }, axisTick: { show: false }, axisLabel: { show: true, color: '#94a3b8', fontSize: 9, interval: 23 } },
        yAxis: { type: 'value', min: 0, splitLine: { show: true, lineStyle: { color: '#e2e8f0', type: 'dashed' } }, axisLabel: { color: '#64748b', fontSize: 9, formatter: '{value}' } },
        series: [
            { name: 'æ˜¨æ—¥', type: 'line', data: state.chartData.yesterdayLoad, showSymbol: false, smooth: true, itemStyle: { color: '#94a3b8' }, lineStyle: { width: 1.5, type: 'dashed' }, z: 1 },
            { name: 'å…‰ä¼', type: 'line', data: state.chartData.solar, showSymbol: false, smooth: true, itemStyle: { color: '#facc15' }, lineStyle: { width: 0 }, areaStyle: { opacity: 0.3 }, z: 2 },
            { name: 'å‚¨èƒ½', type: 'line', data: state.chartData.battery, showSymbol: false, smooth: true, itemStyle: { color: '#22c55e' }, lineStyle: { width: 1.5 }, z: 3 },
            { name: 'ç”µç½‘', type: 'line', data: state.chartData.load, showSymbol: false, smooth: true, itemStyle: { color: '#3b82f6' }, lineStyle: { width: 1.5 }, areaStyle: { opacity: 0.15, color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: 'rgba(59, 130, 246, 0.6)' }, { offset: 1, color: 'rgba(59, 130, 246, 0)' }]) }, z: 4 }
        ]
    };
    myChart.setOption(option);
}

function restartGame() {
    if (state.timer) clearTimeout(state.timer);
    closeModal('game-over-modal');

    // éšè—æ¸¸æˆä¸»ç•Œé¢
    document.getElementById('game-main-container').classList.add('hidden');

    // å¦‚æœæ˜¯å…³å¡æ¨¡å¼ï¼Œè¿”å›å…³å¡é€‰æ‹©ç•Œé¢
    if (currentLevel > 0) {
        openModal('level-select-modal');
        // æ¢å¤è¢«éšè—çš„æŒ‰é’®
        setTimeout(() => {
            const btnFast = document.getElementById('btn-fast');
            const btnSolar = document.getElementById('btn-solar');
            const btnBattery = document.getElementById('btn-battery');
            const btnLoan = document.getElementById('btn-loan');
            const btnSlow = document.getElementById('btn-slow');

            if (btnFast) btnFast.style.display = '';
            if (btnSolar) btnSolar.style.display = '';
            if (btnBattery) btnBattery.style.display = '';
            if (btnLoan) btnLoan.style.display = '';
            if (btnSlow) {
                btnSlow.disabled = false;
                btnSlow.classList.remove('opacity-50');
            }
        }, 100);
    } else {
        // è‡ªç”±æ¨¡å¼ï¼Œè¿”å›åŸèµ·å§‹é¡µ
        openModal('start-modal');
    }

    const btnContinue = document.getElementById('btn-continue');
    if (btnContinue) btnContinue.classList.add('hidden');
    const fxContainer = document.getElementById('fx-container');
    if (fxContainer) fxContainer.innerHTML = '';
}

function continueGame() { closeModal('game-over-modal'); state.paused = false; tick(); }

function openModal(id) {
    const modal = document.getElementById(id);
    if (modal) {
        modal.classList.remove('hidden');
        modalOpenCount++;
        if (!state.paused) { state.paused = true; clearTimeout(state.timer); }
    }
}

function closeModal(id) {
    const modal = document.getElementById(id);
    if (modal) modal.classList.add('hidden');
    modalOpenCount = Math.max(0, modalOpenCount - 1);
}

// ================= è´·æ¬¾ç³»ç»Ÿé€»è¾‘ =================
function openLoanModal() {
    openModal('loan-modal');
    if (state.loan.active) {
        document.getElementById('loan-form').classList.add('hidden');
        document.getElementById('loan-status-view').classList.remove('hidden');
        document.getElementById('status-principal').innerText = `$${Math.round(state.loan.principal)}`;
        document.getElementById('status-days').innerText = state.loan.daysLeft;
    } else {
        document.getElementById('loan-form').classList.remove('hidden');
        document.getElementById('loan-status-view').classList.add('hidden');
        updateLoanPreview();
    }
}

function setLoanType(type) {
    loanConfig.type = type;
    document.getElementById('btn-installment').className = type === 'installment' 
        ? "border-2 border-blue-500 bg-blue-50 text-blue-700 rounded-lg p-2 text-center cursor-pointer transition-colors"
        : "border border-slate-200 text-slate-600 rounded-lg p-2 text-center cursor-pointer transition-colors";
        
    document.getElementById('btn-principal').className = type === 'principal' 
        ? "border-2 border-blue-500 bg-blue-50 text-blue-700 rounded-lg p-2 text-center cursor-pointer transition-colors"
        : "border border-slate-200 text-slate-600 rounded-lg p-2 text-center cursor-pointer transition-colors";
    updateLoanPreview();
}
function updateLoanPreview() {
    const amt = parseInt(document.getElementById('loan-amt-slider').value);
    const days = parseInt(document.getElementById('loan-days-slider').value);
    
    document.getElementById('loan-amt-val').innerText = `$${amt}`;
    document.getElementById('loan-days-val').innerText = `${days}å¤©`;

    const r = LOAN_DAILY_RATE;
    let firstDayPayment = 0;
    let totalRepay = 0;

    // è·å–å½“å‰é€‰ä¸­çš„æ¨¡å¼ (éœ€è¦åœ¨ setLoanType ä¸­æ›´æ–° loanConfig.type)
    // å¦‚æœæ²¡æœ‰ loanConfig å…¨å±€å˜é‡ï¼Œè¯·åœ¨é¡¶éƒ¨å£°æ˜ let loanConfig = { type: 'installment' };
    const type = loanConfig.type; 

    if (type === 'installment') {
        // === ç­‰é¢æœ¬æ¯ (æ¯å¤©è¿˜ä¸€æ ·çš„é’±) ===
        // å…¬å¼: æ¯æ—¥è¿˜æ¬¾ = P * [r * (1+r)^n] / [(1+r)^n - 1]
        const pow = Math.pow(1 + r, days);
        const dailyPayment = (amt * r * pow) / (pow - 1);
        
        firstDayPayment = Math.ceil(dailyPayment);
        totalRepay = Math.ceil(dailyPayment * days);
        
        // é¢„è§ˆæ•°æ®
        window.previewLoanData = {
            principal: amt,
            days: days,
            fixedDaily: Math.ceil(dailyPayment), // å­˜ä¸‹æ¥ï¼Œä»¥åæ¯å¤©æ‰£è¿™ä¸ªæ•°
            totalRepay: totalRepay,
            type: 'installment'
        };

    } else {
        // === ç­‰é¢æœ¬é‡‘ (é¦–æ—¥è¿˜æœ€å¤šï¼Œé€æ—¥é€’å‡) ===
        // æ¯æ—¥å›ºå®šè¿˜æœ¬é‡‘ = æ€»æœ¬é‡‘ / å¤©æ•°
        const dailyPrincipal = amt / days;
        
        // é¦–æ—¥åˆ©æ¯ = æ€»æœ¬é‡‘ * åˆ©ç‡
        const firstDayInterest = amt * r;
        
        firstDayPayment = Math.ceil(dailyPrincipal + firstDayInterest);
        
        // æ€»è¿˜æ¬¾é¢ = æœ¬é‡‘ + æ€»åˆ©æ¯
        // ç­‰é¢æœ¬é‡‘çš„æ€»åˆ©æ¯å…¬å¼ = (n+1) * amt * r / 2
        const totalInterest = (days + 1) * amt * r / 2;
        totalRepay = Math.ceil(amt + totalInterest);

        // é¢„è§ˆæ•°æ®
        window.previewLoanData = {
            principal: amt,
            days: days,
            dailyBasePrincipal: dailyPrincipal, // æ¯å¤©é›·æ‰“ä¸åŠ¨è¿˜è¿™ä¹ˆå¤šæœ¬é‡‘
            totalRepay: totalRepay,
            type: 'principal'
        };
    }

    // æ›´æ–°ç•Œé¢æ˜¾ç¤º
    document.getElementById('loan-total-repay').innerText = `$${totalRepay}`;
    document.getElementById('loan-daily-repay').innerText = `$${firstDayPayment}`;
}

function takeLoan() {
    const data = window.previewLoanData;
    if (!data) return;

    state.money += data.principal;
    
    state.loan = {
        active: true,
        type: data.type,
        
        // é€šç”¨æ•°æ®
        principal: data.principal,       // å½“å‰å‰©ä½™æœ¬é‡‘
        daysLeft: data.days,             // å‰©ä½™å¤©æ•°
        originalDays: data.days,         // åŸå§‹å¤©æ•°ï¼ˆè®¡ç®—ç­‰é¢æœ¬é‡‘åˆ©æ¯éœ€è¦ï¼‰
        
        // ç­‰é¢æœ¬æ¯ä¸“ç”¨æ•°æ®
        fixedDaily: data.fixedDaily || 0,
        
        // ç­‰é¢æœ¬é‡‘ä¸“ç”¨æ•°æ®
        dailyBasePrincipal: data.dailyBasePrincipal || 0
    };

    spawnFloatText(`è´·æ¬¾ +$${data.principal}`, '#2563eb');
    closeLoanModal(); 
    updateUI();
}

function closeLoanModal() {
    closeModal('loan-modal');
    // æ¢å¤åˆ°æ‰“å¼€çª—å£å‰çš„é€Ÿåº¦
    setSpeed(state.lastGameSpeed); 
}

// ================= æ ¸å¿ƒå¾ªç¯ =================

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let canvasWidth, canvasHeight;

function tick() {
    if (state.paused || modalOpenCount > 0) return;

    state.minute += 10;
    
    let gridPrice = CITY_CONFIG[state.settings.city].prices[state.hour];
    if (state.settings.mode === 'collapse') { if (state.hour >= 6 && state.hour < 18) gridPrice = 10.0; else gridPrice = 0.2; }
    if (state.settings.mode === 'offgrid') gridPrice = state.price; 
    
    const discountBuff = state.activeBuffs.find(b => b.type === 'gridDiscount');
    if (discountBuff) gridPrice *= discountBuff.val;
    const gridPriceMultBuff = state.activeBuffs.find(b => b.type === 'gridPriceMult');
    if (gridPriceMultBuff) gridPrice *= gridPriceMultBuff.val;

    let trafficProb = LOC_CONFIG[state.settings.loc].traffic[state.hour] * 0.18;
    if (state.settings.mode === 'ghost') trafficProb *= 0.35;
    if (state.settings.mode === 'jam') trafficProb *= 2;
    if (state.settings.mode === 'luxury') trafficProb *= 2;
    
    const trafficBuff = state.activeBuffs.find(b => b.type === 'trafficMult');
    if (trafficBuff) trafficProb *= trafficBuff.val;

    trySpawnCar(trafficProb);
    processEnergy(gridPrice);

    const timeIndex = state.hour * 6 + (state.minute / 10);
    if (timeIndex >= 0 && timeIndex < 144) {
        const d = state.lastTickData;
        state.chartData.solar[timeIndex] = d.solar;
        state.chartData.battery[timeIndex] = d.batt;
        state.chartData.load[timeIndex] = d.grid;
        
        let currentLimit = CONFIG.baseLoadLimit + (state.assets.transformer * CONFIG.transformerBoost);
        if (state.settings.mode === 'powerlimit') currentLimit = 10 + (state.assets.transformer * 10);

        const isOverloaded = (d.reqLoad || 0) > currentLimit;
        const warningEl = document.getElementById('chart-overload-label');
        if (warningEl) { if (isOverloaded) warningEl.classList.remove('hidden'); else warningEl.classList.add('hidden'); }

        const battStatusEl = document.getElementById('chart-batt-status');
        if (battStatusEl) {
            if (d.battAction === 'charge') {
                battStatusEl.classList.remove('hidden');
                battStatusEl.className = "absolute top-0 left-2 bg-green-50 border border-green-400 text-green-700 text-[9px] font-bold px-2 py-0.5 rounded shadow-sm z-20 flex items-center gap-1 backdrop-blur-sm";
                battStatusEl.innerHTML = `<span>âš¡</span><span>å……ç”µä¸­</span>`;
            } else if (d.battAction === 'discharge') {
                battStatusEl.classList.remove('hidden');
                battStatusEl.className = "absolute top-0 left-2 bg-blue-50 border border-blue-400 text-blue-700 text-[9px] font-bold px-2 py-0.5 rounded shadow-sm z-20 flex items-center gap-1 backdrop-blur-sm";
                battStatusEl.innerHTML = `<span>ğŸ”‹</span><span>æ”¾ç”µä¸­</span>`;
            } else {
                battStatusEl.classList.add('hidden');
            }
        }

        if (myChart) {
            myChart.setOption({
                yAxis: { max: Math.max(currentLimit, 5) },
                series: [
                    { data: state.chartData.yesterdayLoad },
                    { data: state.chartData.solar },
                    { data: state.chartData.battery },
                    { 
                        data: state.chartData.load,
                        markLine: {
                            symbol: ['none', 'none'], 
                            label: { show: true, position: 'insideEndTop', formatter: 'MAX: {c}kW', color: '#ef4444', fontSize: 9, fontWeight: 'bold' },
                            lineStyle: { color: '#ef4444', type: 'dashed', width: 1 },
                            data: [ { yAxis: currentLimit } ],
                            animation: false
                        }
                    }
                ]
            });
        }
    }

    if (checkEndGame()) return;

    if (state.minute >= 60) {
        state.minute = 0;
        state.hour++;
        
        if (state.nextEventTime && state.day === state.nextEventTime.day && state.hour === state.nextEventTime.hour) {
            triggerRandomEvent();
            return;
        }

        if (state.hour >= 24) {
            state.hour = 0;
            dailySettle();
            if (checkEndGame()) return;
        }
    }

    state.cars = state.cars.filter(car => {
        if (car.kwhReceived >= car.kwhNeeded - 0.1) return false;
        car.ticksLeft--;
        return car.ticksLeft > 0;
    });

    updateUI();
    draw();
    state.timer = setTimeout(tick, state.gameSpeed);
}

function checkEndGame() {
    if (state.money < 0) { showGameOver(false); return true; }

    // æ£€æŸ¥å…³å¡èƒœåˆ©æ¡ä»¶
    let targetDays = state.targetDays || CONFIG.targetDays;
    if (state.day > targetDays && !state.victoryAchieved) {
        state.victoryAchieved = true;
        showGameOver(true);
        return true;
    }
    return false;
}

function showGameOver(victory) {
    state.paused = true;
    clearTimeout(state.timer);

    // æ ¹æ®å…³å¡æ˜¾ç¤ºä¸åŒçš„èƒœåˆ©ä¿¡æ¯
    let title, icon, desc, color;
    if (victory) {
        if (currentLevel === 1) {
            title = "ğŸ‰ å…³å¡å®Œæˆï¼";
            icon = "ğŸ†";
            desc = `æ­å–œä½ å®Œæˆäº†"æ–°æ‰‹èµ·æ­¥"å…³å¡ï¼å­˜æ´»äº† ${state.day} å¤©ã€‚`;
            color = "text-green-600";
            // è§£é”ä¸‹ä¸€å…³
            unlockLevel(2);
        } else if (currentLevel === 2) {
            title = "ğŸ‰ å…³å¡å®Œæˆï¼";
            icon = "ğŸ†";
            desc = `æ­å–œä½ å®Œæˆäº†"æ ‡å‡†æŒ‘æˆ˜"å…³å¡ï¼å­˜æ´»äº† ${state.day} å¤©ã€‚`;
            color = "text-blue-600";
            // è§£é”ä¸‹ä¸€å…³
            unlockLevel(3);
        } else if (currentLevel === 3) {
            title = "ğŸ‰ å…³å¡å®Œæˆï¼";
            icon = "ğŸ†";
            desc = `æ­å–œä½ å®Œæˆäº†"è¶…å……ç‹‚çƒ­"å…³å¡ï¼å­˜æ´»äº† ${state.day} å¤©ã€‚`;
            color = "text-yellow-600";
            // è§£é”ä¸‹ä¸€å…³
            unlockLevel(4);
        } else if (currentLevel === 4) {
            title = "ğŸ‰ å…¨éƒ¨é€šå…³ï¼";
            icon = "ğŸ‘‘";
            desc = `æ­å–œä½ é€šå…³äº†æ‰€æœ‰å…³å¡ï¼ä½ æ˜¯çœŸæ­£çš„å……ç”µç«™å¤§äº¨ï¼`;
            color = "text-purple-600";
        } else {
            title = "ğŸ‰ å•†ä¸šä¼ å¥‡ï¼";
            icon = "ğŸ†";
            desc = `æ­å–œä½ æˆåŠŸè¿è¥äº† ${CONFIG.targetDays} å¤©ï¼ä½ çš„å……ç”µå¸å›½å·²ç»åšä¸å¯æ‘§ã€‚`;
            color = "text-yellow-600";
        }
    } else {
        title = "ğŸ’€ ç ´äº§æ¸…ç®—";
        icon = "ğŸ’¸";
        desc = "èµ„é‡‘é“¾æ–­è£‚ï¼Œä½ çš„å……ç”µç«™å€’é—­äº†ã€‚";
        color = "text-red-600";
    }

    document.getElementById('go-title').innerText = title;
    document.getElementById('go-title').className = `text-3xl font-black mb-2 ${color}`;
    document.getElementById('go-icon').innerText = icon;
    document.getElementById('go-desc').innerText = desc;
    document.getElementById('final-days').innerText = state.day;

    if (victory) {
        const btnContinue = document.getElementById('btn-continue');
        if (btnContinue) btnContinue.classList.remove('hidden');
    }
    openModal('game-over-modal');
}

function processEnergy(gridPrice) {
    let totalRequestedKw = 0;
    state.cars.forEach(car => { if (car.kwhReceived < car.kwhNeeded) totalRequestedKw += CONFIG.chargerPower[car.type]; });

    let limitKw = CONFIG.baseLoadLimit + (state.assets.transformer * CONFIG.transformerBoost);
    if (state.settings.mode === 'powerlimit') limitKw = 10 + (state.assets.transformer * 10);
    
    let throttle = 1.0;
    if (totalRequestedKw > limitKw) throttle = limitKw / totalRequestedKw;

    const actualTotalKw = totalRequestedKw * throttle;
    const actualTotalKwhPerTick = actualTotalKw / 6; 

    const chargeSpeedBuff = state.activeBuffs.find(b => b.type === 'chargeSpeedMult');
    let chargeSpeedMult = chargeSpeedBuff ? chargeSpeedBuff.val : 1.0;

    state.cars.forEach(car => {
        const pKw = CONFIG.chargerPower[car.type] * chargeSpeedMult;
        const pKwh = (pKw * throttle) / 6;
        const need = car.kwhNeeded - car.kwhReceived;
        const added = Math.min(pKwh, need);
        car.kwhReceived += added;
    });

    let sunH = (state.hour >= 6 && state.hour <= 18) ? Math.sin((state.hour-6)/12*Math.PI) : 0;
    let weatherEff = CONFIG.weather.eff[state.weather];
    
    const weatherBuff = state.activeBuffs.find(b => b.type === 'forcedWeather');
    if (weatherBuff) weatherEff = CONFIG.weather.eff[weatherBuff.val]; 
    const solarBuff = state.activeBuffs.find(b => b.type === 'solarEfficiency');
    if (solarBuff) weatherEff *= solarBuff.val; 

    const randomFactor = 0.9 + (Math.sin(state.minute) * 0.1); 
    const solarKwh = state.assets.solar * CONFIG.solarMax * sunH * weatherEff * randomFactor / 6; 

    let remainDemandKwh = actualTotalKwhPerTick;
    let usedSolarKwh = Math.min(remainDemandKwh, solarKwh);
    remainDemandKwh -= usedSolarKwh;
    
    let surplusSolar = solarKwh - usedSolarKwh;
    const batMaxKwh = state.assets.battery * CONFIG.batteryCap;
    
    if (surplusSolar > 0 && state.batteryKwh < batMaxKwh) {
        const canStore = batMaxKwh - state.batteryKwh;
        state.batteryKwh += Math.min(surplusSolar, canStore);
    }

    let usedBattKwh = 0;
    let gridChargeKwh = 0;
    let battAction = 'idle';

    const batRateKwh = (state.assets.battery * CONFIG.batteryRate) / 6; 
    const batteryEffBuff = state.activeBuffs.find(b => b.type === 'batteryEfficiency');
    let batteryEffMult = batteryEffBuff ? batteryEffBuff.val : 1.0;

    const CHARGE_THRESHOLD = 0.45; 

    if (gridPrice <= CHARGE_THRESHOLD && state.batteryKwh < batMaxKwh) {
        const amt = Math.min(batMaxKwh - state.batteryKwh, batRateKwh * batteryEffMult);
        state.batteryKwh += amt;
        gridChargeKwh = amt;
        battAction = 'charge';
    } else if (state.batteryKwh > 0 && remainDemandKwh > 0) {
        const amt = Math.min(state.batteryKwh, batRateKwh * batteryEffMult, remainDemandKwh);
        state.batteryKwh -= amt;
        remainDemandKwh -= amt;
        usedBattKwh = amt;
        battAction = 'discharge';
    }

    let usedGridKwh = remainDemandKwh + gridChargeKwh;
    let revenue = 0;
    state.cars.forEach(car => {
        const pKw = CONFIG.chargerPower[car.type];
        const pKwh = (pKw * throttle) / 6;
        const need = car.kwhNeeded - car.kwhReceived; 
        const added = Math.min(pKwh, need); 
        if (added > 0) revenue += added * car.priceLocked;
    });

    const cost = usedGridKwh * gridPrice;
    const profit = revenue - cost;

    state.money += profit;
    state.currentDayProfit += profit;

    const profitEl = document.getElementById('ui-tick-profit');
    if (profit !== 0) {
        profitEl.innerText = (profit > 0 ? "+" : "") + profit.toFixed(1);
        profitEl.className = `realtime-profit show ${profit > 0 ? 'profit-plus' : 'profit-minus'}`;
        setTimeout(() => { profitEl.classList.remove('show'); }, 800);
    }

    state.lastTickData = {
        load: actualTotalKw, reqLoad: totalRequestedKw, limit: limitKw,
        solar: usedSolarKwh * 6, batt: usedBattKwh * 6, grid: usedGridKwh * 6,
        battAction: battAction
    };

    if (state.gameSpeed >= 125 && profit !== 0 && state.minute % 20 === 0) {
        const col = profit > 0 ? '#16a34a' : '#ef4444';
        const txt = profit > 0 ? `+${profit.toFixed(2)}` : `${profit.toFixed(2)}`;
        if(Math.random() > 0.7) spawnFloatText(txt, col);
    }
}

function scheduleNextEvent() {
    const offset = 2 + Math.floor(Math.random() * 4); 
    const hour = 9 + Math.floor(Math.random() * 9); 
    state.nextEventTime = { day: state.day + offset, hour: hour };
}

const EVENTS = {
    instant: [
        { t: "æ”¿åºœè¡¥è´´", d: "æ–°èƒ½æºåŸºå»ºè¡¥åŠ©åˆ°è´¦ã€‚", amt: 500, type: 'money' },
        { t: "è®¾å¤‡è¿‡çƒ­", d: "å‡ ä¸ªæ¨¡å—çƒ§åäº†ï¼Œéœ€ç´§æ€¥ç»´ä¿®ã€‚", amt: -300, type: 'money' },
        { t: "ç½‘çº¢æ‰“å¡", d: "æŸè½¦è¯„äººæ¥è¿™å……ç”µï¼Œç¬é—´å¼•æµã€‚", amt: 400, type: 'money' },
        { t: "å·ç”µè´¼", d: "æœ‰äººç§æ¥ç”µçº¿å·ç”µè¢«æŠ“ï¼Œç½šæ¬¾ã€‚", amt: -150, type: 'money' },
        { t: "ç¯ä¿ç½šå•", d: "ç”µæ± åºŸæ¶²å¤„ç†ä¸å½“ï¼Œç¯ä¿å±€æ‰¾ä¸Šé—¨ã€‚", amt: -500, type: 'money' },
        { t: "å½©ç¥¨ä¸­å¥–", d: "ä½ åœ¨ä¼‘æ¯å®¤æ¡åˆ°çš„å½©ç¥¨ä¸­äº†äºŒç­‰å¥–ï¼", amt: 800, type: 'money' },
        { t: "è®¾å¤‡è€åŒ–", d: "éƒ¨åˆ†è®¾å¤‡è€åŒ–ä¸¥é‡ï¼Œéœ€è¦æ›´æ¢é›¶ä»¶ã€‚", amt: -250, type: 'money' },
        { t: "å®¢æˆ·æ‰“èµ", d: "åœŸè±ªè½¦ä¸»è§‰å¾—ä½ æœåŠ¡ä¸é”™ï¼Œç»™äº†å°è´¹ã€‚", amt: 100, type: 'money' },
        { t: "ä¿é™©ç†èµ”", d: "ä¸Šæ¬¡é›·å‡»æŸåçš„è®¾å¤‡ï¼Œä¿é™©å…¬å¸èµ”ä»˜äº†ã€‚", amt: 600, type: 'money' },
        { t: "å‘˜å·¥åŸ¹è®­", d: "ç»„ç»‡å‘˜å·¥å‚åŠ ä¸“ä¸šåŸ¹è®­ï¼Œæå‡æœåŠ¡è´¨é‡ã€‚", amt: -200, type: 'money' },
        { t: "é“¶è¡Œåˆ©æ¯", d: "è´¦æˆ·ä½™é¢äº§ç”Ÿçš„åˆ©æ¯åˆ°è´¦ã€‚", amt: 150, type: 'money' },
        { t: "è®¾å¤‡è¢«ç›—", d: "æœ‰äººå¤œé—´å·èµ°äº†éƒ¨åˆ†å……ç”µè®¾å¤‡ã€‚", amt: -400, type: 'money' },
        { t: "æ”¿åºœå¥–åŠ±", d: "è¢«è¯„ä¸ºç»¿è‰²èƒ½æºç¤ºèŒƒç«™ç‚¹ï¼Œè·å¾—å¥–åŠ±ã€‚", amt: 700, type: 'money' },
        { t: "ç»´ä¿®äº‹æ•…", d: "ç»´ä¿®è¿‡ç¨‹ä¸­å‘ç”Ÿæ„å¤–ï¼Œéœ€è¦é¢å¤–èµ”å¿ã€‚", amt: -350, type: 'money' },
        { t: "å¹¿å‘Šæ”¶å…¥", d: "åœ¨å……ç”µæ¡©ä¸ŠæŠ•æ”¾å¹¿å‘Šè·å¾—æ”¶å…¥ã€‚", amt: 300, type: 'money' },
        { t: "ç¨åŠ¡æŠ½æŸ¥", d: "ç¨åŠ¡éƒ¨é—¨æŠ½æŸ¥å‘ç°æ¼ç¨é—®é¢˜ï¼Œè¡¥ç¼´ç¨æ¬¾ã€‚", amt: -450, type: 'money' },
        { t: "èŠ‚èƒ½è¡¥è´´", d: "ä½¿ç”¨èŠ‚èƒ½è®¾å¤‡è·å¾—é¢å¤–è¡¥è´´ã€‚", amt: 250, type: 'money' },
        { t: "å®¢æˆ·æŠ•è¯‰", d: "æœåŠ¡æ€åº¦é—®é¢˜å¯¼è‡´å®¢æˆ·æŠ•è¯‰ï¼Œèµ”å¿æŸå¤±ã€‚", amt: -180, type: 'money' },
        { t: "æŠ€æœ¯å‡çº§", d: "ç³»ç»ŸæŠ€æœ¯å‡çº§ï¼Œæå‡å……ç”µæ•ˆç‡ã€‚", amt: -320, type: 'money' },
        { t: "åˆä½œæ¨å¹¿", d: "ä¸é™„è¿‘å•†å®¶åˆä½œæ¨å¹¿ï¼Œè·å¾—æ¨å¹¿è´¹ã€‚", amt: 350, type: 'money' }
    ],
    longTerm: [
        { t: "å°é£è¿‡å¢ƒ", d: "å°é£'çš®å¡ä¸˜'æ¥è¢­ï¼æš´é›¨ä¸æ–­ï¼Œå…‰ä¼å‘ç”µåŸºæœ¬æŠ¥åºŸã€‚", type: 'forcedWeather', val: 'rainy', icon: 'â›ˆï¸' },
        { t: "åŸææ–™æš´è·Œ", d: "å›½é™…é“œä»·å´©ç›˜ï¼ç”µç½‘ç”µä»·æ‰“8æŠ˜ã€‚", type: 'gridDiscount', val: 0.8, icon: 'ğŸ“‰' },
        { t: "åŸå¸‚é©¬æ‹‰æ¾", d: "å…¨åŸå°è·¯è·‘é©¬æ‹‰æ¾ã€‚å®¢æµå‡åŠã€‚", type: 'trafficMult', val: 0.5, icon: 'ğŸƒ' },
        { t: "é«˜æ¸©é¢„è­¦", d: "è¿æ—¥é«˜æ¸©ï¼Œå¤§å®¶éƒ½ä¸æƒ³å‡ºé—¨ã€‚ä½†å…‰ä¼æ•ˆç‡çˆ†è¡¨(120%)ï¼", type: 'multiBuff', buffs: [ { type: 'forcedWeather', val: 'sunny' }, { type: 'solarEfficiency', val: 1.2 } ], icon: 'ğŸ¥µ' },
        { t: "æ²¹ä»·æš´æ¶¨", d: "å›½é™…æ²¹ä»·èµ·é£ï¼Œå¼€æ²¹è½¦çš„éƒ½å“­äº†ã€‚å®¢æµ +50%ã€‚", type: 'trafficMult', val: 1.5, icon: 'â›½' },
        { t: "ç”µæ± æŠ€æœ¯çªç ´", d: "å®ç‹å‘å¸ƒæ–°ç”µæ± ï¼Œå‚¨èƒ½è®¾å¤‡é‡‡è´­æ‰“7æŠ˜ï¼", type: 'assetDiscount', target: 'battery', val: 0.7, icon: 'ğŸ”‹' },
        { t: "å…‰ä¼äº§èƒ½è¿‡å‰©", d: "ç»„ä»¶å‚æ¸…åº“å­˜ï¼Œå…‰ä¼æ¿é‡‡è´­æ‰“7æŠ˜ï¼", type: 'assetDiscount', target: 'solar', val: 0.7, icon: 'ğŸ“‰' },
        { t: "åŸºå»ºç‹‚é­”", d: "å·¥ç¨‹é˜Ÿå¤§ä¿ƒé”€ï¼Œå……ç”µæ¡©å’Œå˜å‹å™¨å®‰è£…è´¹8æŠ˜ï¼", type: 'assetDiscount', target: 'infra', val: 0.8, icon: 'ğŸ—ï¸' },
        { t: "æå¯’å¤©æ°”", d: "å¯’æ½®æ¥è¢­ï¼ç”µæ± æ•ˆç‡ä¸‹é™30%ï¼Œä½†ç”µç½‘éœ€æ±‚æ¿€å¢ç”µä»·ä¸Šæ¶¨ã€‚", type: 'multiBuff', buffs: [ { type: 'batteryEfficiency', val: 0.7 }, { type: 'gridPriceMult', val: 1.4 } ], icon: 'â„ï¸' },
        { t: "å……ç”µè”ç›Ÿ", d: "åŠ å…¥åŸå¸‚å……ç”µè”ç›Ÿï¼Œå®¢æµå¢åŠ ä½†éœ€æ”¯ä»˜è”ç›Ÿè´¹ç”¨ã€‚", type: 'multiBuff', buffs: [ { type: 'trafficMult', val: 1.4 }, { type: 'dailyCostMult', val: 1.2 } ], icon: 'ğŸ¤' },
        { t: "æŠ€æœ¯é©æ–°", d: "æ–°æŠ€æœ¯è®©å……ç”µé€Ÿåº¦æå‡20%ï¼Œä½†è®¾å¤‡ç»´æŠ¤æˆæœ¬å¢åŠ ã€‚", type: 'multiBuff', buffs: [ { type: 'chargeSpeedMult', val: 1.2 }, { type: 'dailyCostMult', val: 1.15 } ], icon: 'âš¡' },
        { t: "æ”¿ç­–è¡¥è´´", d: "æ”¿åºœæ¨å‡ºæ–°èƒ½æºè¡¥è´´æ”¿ç­–ï¼Œç”µä»·æ‰“7æŠ˜ã€‚", type: 'gridDiscount', val: 0.7, icon: 'ğŸ›ï¸' },
        { t: "ç”¨ç”µé«˜å³°", d: "å¤å­£ç”¨ç”µé«˜å³°æœŸï¼Œç”µç½‘ä»·æ ¼é£™å‡50%ã€‚", type: 'gridPriceMult', val: 1.5, icon: 'ğŸ“ˆ' },
        { t: "è®¾å¤‡å‡çº§", d: "æ™ºèƒ½åŒ–å‡çº§å®Œæˆï¼Œè®¾å¤‡æ•ˆç‡æå‡ä½†ç»´æŠ¤æˆæœ¬å¢åŠ ã€‚", type: 'multiBuff', buffs: [ { type: 'solarEfficiency', val: 1.3 }, { type: 'batteryEfficiency', val: 1.2 }, { type: 'dailyCostMult', val: 1.25 } ], icon: 'ğŸ¤–' },
        { t: "å¸‚åœºç«äº‰", d: "é™„è¿‘æ–°å¼€å……ç”µç«™ï¼Œå®¢æµå‡å°‘25%ã€‚", type: 'trafficMult', val: 0.75, icon: 'âš”ï¸' },
        { t: "èƒ½æºå±æœº", d: "å›½é™…èƒ½æºå±æœºï¼Œæ‰€æœ‰èƒ½æºä»·æ ¼ä¸Šæ¶¨ã€‚", type: 'multiBuff', buffs: [ { type: 'gridPriceMult', val: 1.6 }, { type: 'dailyCostMult', val: 1.3 } ], icon: 'ğŸ›¢ï¸' },
        { t: "ç»¿è‰²è®¤è¯", d: "è·å¾—ç¯ä¿è®¤è¯ï¼Œè®¾å¤‡é‡‡è´­äº«å—æŠ˜æ‰£ã€‚", type: 'assetDiscount', target: 'all', val: 0.85, icon: 'ğŸŒ±' },
        { t: "æ™ºèƒ½åŒ–æµªæ½®", d: "AIæŠ€æœ¯æ™®åŠï¼Œæ™ºèƒ½åŒ–è®¾å¤‡æˆæœ¬å¤§å¹…ä¸‹é™ã€‚", type: 'assetDiscount', target: 'infra', val: 0.6, icon: 'ğŸ§ ' },
        { t: "ç»æµè¡°é€€", d: "ç»æµä¸æ™¯æ°”ï¼Œå®¢æµå‡å°‘ä½†è¿è¥æˆæœ¬ä¸‹é™ã€‚", type: 'multiBuff', buffs: [ { type: 'trafficMult', val: 0.7 }, { type: 'dailyCostMult', val: 0.8 } ], icon: 'ğŸ“‰' },
        { t: "å……ç”µçƒ­æ½®", d: "ç”µåŠ¨è½¦é”€é‡æš´å¢ï¼Œå®¢æµå¢åŠ 40%ã€‚", type: 'trafficMult', val: 1.4, icon: 'ğŸš—' },
        { t: "ç»´æŠ¤å›°éš¾", d: "ä¸“ä¸šæŠ€æœ¯äººå‘˜çŸ­ç¼ºï¼Œç»´æŠ¤æˆæœ¬å¤§å¹…ä¸Šå‡ã€‚", type: 'dailyCostMult', val: 1.5, icon: 'ğŸ”§' },
        { t: "åˆ›æ–°è¡¥è´´", d: "åˆ›æ–°æŠ€æœ¯è·å¾—æ”¿åºœè¡¥è´´ï¼Œç ”å‘æˆæœ¬é™ä½ã€‚", type: 'assetDiscount', target: 'battery', val: 0.5, icon: 'ğŸ’¡' }
    ]
};

function triggerRandomEvent() {
    const hasActiveLongTerm = state.activeBuffs.some(b => b.isEventLongTerm);
    const isLongTerm = !hasActiveLongTerm && Math.random() < 0.4;
    let ev;
    let duration = 0;

    if (isLongTerm) {
        ev = EVENTS.longTerm[Math.floor(Math.random() * EVENTS.longTerm.length)];
        duration = 2 + Math.floor(Math.random() * 6);
        if (ev.type === 'multiBuff') {
            ev.buffs.forEach(subBuff => {
                state.activeBuffs.push({ name: ev.t, type: subBuff.type, val: subBuff.val, daysLeft: duration, icon: ev.icon, isEventLongTerm: true });
            });
        } else {
            state.activeBuffs.push({ name: ev.t, type: ev.type, val: ev.val, daysLeft: duration, icon: ev.icon, isEventLongTerm: true, target: ev.target });
        }
        document.getElementById('ev-amt').innerText = `æŒç»­ ${duration} å¤©`;
        document.getElementById('ev-amt').className = "font-bold text-blue-600";
    } else {
        let candidateEvents = EVENTS.instant;
        const currentRent = calcWeeklyRent(); 
        
        if (state.money < currentRent) {
            candidateEvents = candidateEvents.filter(e => e.amt > 0);
        } else if (state.money < currentRent * 1.5) {
            const goodEvents = candidateEvents.filter(e => e.amt > 0);
            candidateEvents = [...candidateEvents, ...goodEvents, ...goodEvents];
        }

        ev = candidateEvents[Math.floor(Math.random() * candidateEvents.length)];
        
        let inflation = 0;
        if (ev.amt !== 0) { inflation = (ev.amt > 0 ? 1 : -1) * state.day * 5; }
        let amount = ev.amt + inflation;
        
        state.money += amount;
        document.getElementById('ev-amt').innerText = (amount > 0 ? "+" : "") + `$${Math.abs(amount)}`;
        document.getElementById('ev-amt').className = amount > 0 ? "font-bold font-mono text-lg text-green-600" : "font-bold font-mono text-lg text-red-600";
    }

    document.getElementById('ev-icon').innerText = isLongTerm ? ev.icon : (ev.amt > 0 ? 'ğŸ’°' : 'ğŸ’¸');
    document.getElementById('ev-title').innerText = ev.t;
    document.getElementById('ev-desc').innerText = ev.d;
    openModal('event-modal');
    updateUI(); 
    scheduleNextEvent();
}

function dailySettle() {
    state.day++;
    state.weather = state.forecast;
    const forcedWeather = state.activeBuffs.find(b => b.type === 'forcedWeather');
    if (forcedWeather) state.weather = forcedWeather.val;
    state.forecast = rollWeather();

    state.activeBuffs.forEach(b => b.daysLeft--);
    state.activeBuffs = state.activeBuffs.filter(b => b.daysLeft > 0);

    const dailyCost = calcDailyCost();
    state.money -= dailyCost;
    spawnFloatText(`æ—¥ç»´æŠ¤ -$${dailyCost}`, '#f97316');
    
    // === è´·æ¬¾æ‰£æ¬¾é€»è¾‘ ===
// === è´·æ¬¾æ‰£æ¬¾é€»è¾‘ (æ—¥åˆ©ç‡ç‰ˆ) ===
// === è´·æ¬¾æ‰£æ¬¾é€»è¾‘ (ä¿®å¤ç‰ˆ) ===
    if (state.loan.active) {
        let payAmount = 0;
        let interestPart = 0;
        let principalPart = 0;

        if (state.loan.type === 'installment') {
            // [ç­‰é¢æœ¬æ¯]ï¼šæ¯å¤©æ‰£å›ºå®šé‡‘é¢
            payAmount = state.loan.fixedDaily;
            
            // å€’æ¨åˆ©æ¯ç”¨äºæ˜¾ç¤ºï¼šåˆ©æ¯ = å‰©ä½™æœ¬é‡‘ * åˆ©ç‡
            interestPart = state.loan.principal * LOAN_DAILY_RATE;
            principalPart = payAmount - interestPart;
        } else {
            // [ç­‰é¢æœ¬é‡‘]ï¼šæ¯å¤©æ‰£ (å›ºå®šæœ¬é‡‘ + å‰©ä½™æœ¬é‡‘äº§ç”Ÿçš„åˆ©æ¯)
            principalPart = state.loan.dailyBasePrincipal;
            interestPart = state.loan.principal * LOAN_DAILY_RATE;
            
            // ä¸ºäº†é˜²æ­¢æœ€åä¸€å¤©æµ®ç‚¹æ•°è¯¯å·®ï¼Œå¦‚æœæ˜¯æœ€åä¸€å¤©ï¼Œç›´æ¥è¿˜æ¸…å‰©ä½™æœ¬é‡‘
            if (state.loan.daysLeft === 1) {
                principalPart = state.loan.principal;
            }
            
            payAmount = Math.ceil(principalPart + interestPart);
        }

        // æ‰§è¡Œæ‰£æ¬¾
        state.money -= payAmount;
        
        // æ›´æ–°è´·æ¬¾çŠ¶æ€
        state.loan.principal -= principalPart; // æ‰£é™¤æœ¬é‡‘
        // ä¿®æ­£æœ¬é‡‘å¯èƒ½å‡ºç°çš„å¾®å°è´Ÿæ•°ï¼ˆæµ®ç‚¹è¯¯å·®ï¼‰
        if(state.loan.principal < 0) state.loan.principal = 0;
        
        state.loan.daysLeft--;

        // æµ®åŠ¨æ–‡å­—
        spawnFloatText(`è¿˜è´· -$${payAmount} (æ¯$${interestPart.toFixed(0)})`, '#4f46e5');

        // ç»“æ¸…åˆ¤æ–­
        if (state.loan.daysLeft <= 0 || state.loan.principal <= 0.1) {
            state.loan.active = false;
            state.loan.principal = 0;
            spawnFloatText("è´·æ¬¾ç»“æ¸…!", '#16a34a');
        }
    }

    if (state.settings.mode === 'jam') state.dailyPoolLeft = 999;
    else if (state.settings.mode === 'ghost') state.dailyPoolLeft = 15;
    else if (state.settings.mode === 'powerlimit') state.dailyPoolLeft = state.dailyPoolMax;
    else state.dailyPoolLeft = state.dailyPoolMax; 

    state.lastDayProfit = state.currentDayProfit - dailyCost;
    state.currentDayProfit = 0;

    state.chartData.yesterdayLoad = [...state.chartData.load];
    state.chartData.load.fill(null);
    state.chartData.solar.fill(null);
    state.chartData.battery.fill(null);
    
    if(myChart) {
        myChart.setOption({ series: [ { data: state.chartData.yesterdayLoad }, { data: [] }, { data: [] }, { data: [] } ] });
    }

    let rentInterval = 7;
    if (state.settings.mode === 'shark') rentInterval = 3;

    if (state.day > 1 && (state.day - 1) % rentInterval === 0) {
        const rent = calcWeeklyRent();
        state.pendingRent = rent;
        showBillModal();
    }
}

function rollWeather() {
    const r = Math.random();
    let cumulativeProb = 0;
    for (let i = 0; i < CONFIG.weather.types.length; i++) {
        cumulativeProb += CONFIG.weather.probs[i];
        if (r < cumulativeProb) return CONFIG.weather.types[i];
    }
    return CONFIG.weather.types[0];
}

function calcDailyCost() {
    let cost = 0;
    cost += state.assets.slowCharger * CONFIG.dailyCost.slowCharger;
    cost += state.assets.fastCharger * CONFIG.dailyCost.fastCharger;
    cost += state.assets.solar * CONFIG.dailyCost.solar;
    cost += state.assets.battery * CONFIG.dailyCost.battery;
    cost += state.assets.transformer * CONFIG.dailyCost.transformer;
    const dailyCostMultBuff = state.activeBuffs.find(b => b.type === 'dailyCostMult');
    if (dailyCostMultBuff) cost *= dailyCostMultBuff.val;
    return cost;
}

function calcWeeklyRent() {
    let base = CONFIG.baseWeeklyRent; 
    let growth = CONFIG.rentGrowth;
    if (state.settings.mode === 'offgrid' || state.settings.mode === 'powerlimit') { base = 500; growth = 125; }
    if (state.settings.mode === 'luxury') { base = 2000; growth = 350; }
    if (state.settings.mode === 'inflation') return Math.floor(base * Math.pow(1.3, state.weeksSurvived));
    if (state.settings.mode === 'shark') { base = 1500; growth = 200; }
    return base + (state.weeksSurvived * growth);
}

function trySpawnCar(baseProb) {
    if (state.dailyPoolLeft <= 0) return;
    const totalChargers = state.assets.slowCharger + state.assets.fastCharger;
    const spawnAttempts = 2 + Math.floor(totalChargers * 0.8); 
    for (let i = 0; i < spawnAttempts; i++) {
        if (state.dailyPoolLeft <= 0) break;
        attemptSingleSpawn(baseProb);
    }
}

function attemptSingleSpawn(baseProb) {
    let weatherMod = 1.0;
    if (state.weather === 'rainy') weatherMod = 0.9;
    if (Math.random() > baseProb * weatherMod) return;

    const myPrice = state.price;
    let acceptChance = 1.0;
    if (myPrice > 2.0) {
        const excess = myPrice - 2.0;
        acceptChance = 0.2 / (excess * 2 + 1); 
    } else {
        if (myPrice <= 1.2) acceptChance = 1.0;
        else { const t = (myPrice - 1.2) / 0.8; acceptChance = 1.0 - (t * 0.7); }
    }
    if (state.settings.mode === 'luxury') acceptChance = Math.min(1.0, acceptChance * 1.3); 

    if (Math.random() > acceptChance) return; 

    const wantFast = Math.random() < 0.3; 
    let spawnType = null;
    let slot = -1;

    if (state.settings.mode === 'super') {
        slot = findFreeSlot('fast');
        if (slot !== -1) spawnType = 'fast';
    } else {
        if (wantFast) {
            slot = findFreeSlot('fast');
            if (slot !== -1) spawnType = 'fast';
            else if (Math.random() < 0.5) { 
                slot = findFreeSlot('slow');
                if (slot !== -1) spawnType = 'slow';
            }
        } else {
            slot = findFreeSlot('slow');
            if (slot !== -1) {
                spawnType = 'slow';
            } else if (findFreeSlot('fast') !== -1) {
                slot = findFreeSlot('fast');
                spawnType = 'fast'; 
            }
        }
    }

    if (spawnType && slot !== -1) {
        state.dailyPoolLeft--;
        const kwhNeed = 45 + Math.random() * 15;
        const power = CONFIG.chargerPower[spawnType];
        const idealTicks = Math.ceil((kwhNeed / power) * 6);
        const patience = Math.ceil(idealTicks * 1.5);
        const emoji = CONFIG.carEmojis[Math.floor(Math.random() * CONFIG.carEmojis.length)];

        state.cars.push({
            type: spawnType, slot: slot, ticksLeft: patience, kwhNeeded: kwhNeed, kwhReceived: 0,
            emoji: emoji, priceLocked: state.price
        });
    }
}

function findFreeSlot(type) {
    const limit = state.assets[type + 'Charger'];
    for(let i=0; i<limit; i++) {
        if (!state.cars.some(c => c.type === type && c.slot === i)) return i;
    }
    return -1;
}

function getAssetCost(type) {
    let cost = state.currentCosts[type];
    const discount = state.activeBuffs.find(b => b.type === 'assetDiscount' && b.target === type);
    if (discount) cost *= discount.val;
    if (['slowCharger', 'fastCharger', 'transformer'].includes(type)) {
        const infraDiscount = state.activeBuffs.find(b => b.type === 'assetDiscount' && b.target === 'infra');
        if (infraDiscount) cost *= infraDiscount.val;
    }
    const allDiscount = state.activeBuffs.find(b => b.type === 'assetDiscount' && b.target === 'all');
    if (allDiscount) cost *= allDiscount.val;
    return Math.floor(cost);
}

function buyAsset(type) {
    const cost = getAssetCost(type);
    if (type === 'slowCharger' && state.settings.mode === 'super') { spawnFloatText("æ¨¡å¼é™åˆ¶: ç¦æ­¢æ…¢å……", "#ef4444"); return; }
    if (state.money >= cost) {
        state.money -= cost;
        if (type === 'marketing') {
            state.dailyPoolMax += 10; state.dailyPoolLeft += 10; spawnFloatText("å®¢æµ+10", "#ec4899");
        } else {
            state.assets[type]++; spawnFloatText(`è´­ä¹° -$${cost}`, "#2563eb");
        }
        state.currentCosts[type] = Math.floor(state.currentCosts[type] * CONFIG.inflationRate);
        updateUI(); resizeCanvas();
    } else {
        spawnFloatText("èµ„é‡‘ä¸è¶³", "#ef4444");
    }
}

function spawnFloatText(txt, col) {
    const el = document.createElement('div');
    el.className = 'float-text';
    el.innerText = txt;
    el.style.color = col;
    el.style.left = (30+Math.random()*40)+'%';
    el.style.top = (40+Math.random()*20)+'%';
    document.getElementById('fx-container').appendChild(el);
    setTimeout(()=>el.remove(), 1200);
}

function updateUI() {
    document.getElementById('ui-money').innerText = `$${state.money.toFixed(2)}`;
    
    const dCost = calcDailyCost();
    document.getElementById('ui-daily-cost').innerText = `-$${dCost.toFixed(2)}`;
    const wRent = calcWeeklyRent();
    document.getElementById('ui-weekly-rent').innerText = `-$${wRent}`;
    
// æ›´æ–°è´·æ¬¾å¡ç‰‡
    const loanCard = document.getElementById('card-loan-status');
    const loanPaymentEl = document.getElementById('ui-loan-payment');
    
    if (state.loan.active) {
        loanCard.className = "stat-card border-t-4 border-indigo-500 bg-indigo-50/50 cursor-pointer";
        
        let nextPayment = 0;
        if (state.loan.type === 'installment') {
            // ç­‰é¢æœ¬æ¯ï¼šè¿˜æ˜¯é‚£ä¸ªå›ºå®šçš„æ•°
            nextPayment = state.loan.fixedDaily;
        } else {
            // ç­‰é¢æœ¬é‡‘ï¼šè®¡ç®—æ˜å¤©çš„è¿˜æ¬¾é¢ (å›ºå®šæœ¬é‡‘ + å½“å‰å‰©ä½™æœ¬é‡‘*åˆ©ç‡)
            // æ³¨æ„ï¼šå› ä¸ºæ˜¯é¢„å‘Šâ€œä»Šæ—¥è¿˜æ¬¾â€ï¼Œä¹Ÿå°±æ˜¯ä¸‹æ¬¡ç»“ç®—æ—¶çš„é‡‘é¢ï¼Œç›´æ¥ç”¨å½“å‰æœ¬é‡‘ç®—å³å¯
            const principalPart = state.loan.dailyBasePrincipal;
            const interestPart = state.loan.principal * LOAN_DAILY_RATE;
            nextPayment = Math.ceil(principalPart + interestPart);
        }
        
        loanPaymentEl.innerText = `-$${nextPayment}`;
    } else {
        loanCard.className = "stat-card border-t-4 border-slate-300 opacity-60 cursor-pointer";
        loanPaymentEl.innerText = "--";
    }

    const daysLeft = 8 - ((state.day - 1) % 7 + 1);
    let rentLabel = 'å‘¨ç§Ÿ';
    if(state.settings.mode === 'shark') {
        const sharkDaysLeft = 4 - ((state.day - 1) % 3 + 1);
        document.getElementById('ui-rent-countdown').innerText = sharkDaysLeft === 1 ? 'æ˜æ—¥' : `${sharkDaysLeft}d`;
        rentLabel = 'é«˜åˆ©è´·';
    } else {
        document.getElementById('ui-rent-countdown').innerText = daysLeft === 1 ? 'æ˜æ—¥' : `${daysLeft}d`;
    }
    // Update label text logic if needed, currently fixed in HTML structure or controlled here
    
    const transformerLabel = document.getElementById('transformer-sub');
    if (state.settings.mode === 'powerlimit') transformerLabel.innerText = '+10kW';
    else transformerLabel.innerText = '+20kW';

    const lastProfitEl = document.getElementById('ui-last-profit');
    if (state.lastDayProfit !== null) {
        const val = state.lastDayProfit.toFixed(2);
        const sign = state.lastDayProfit >= 0 ? '+' : '';
        const color = state.lastDayProfit >= 0 ? 'text-green-600' : 'text-red-500';
        lastProfitEl.innerHTML = `æ˜¨æ—¥: <span class="${color}">${sign}$${val}</span>`;
    } else {
        lastProfitEl.innerText = "æ˜¨æ—¥: --";
    }

    const h = state.hour.toString().padStart(2,'0');
    const m = state.minute.toString().padStart(2,'0');
    document.getElementById('ui-clock').innerText = `${h}:${m}`;
    document.getElementById('ui-day').innerText = `D${state.day}`;
    document.getElementById('ui-pool').innerText = state.settings.mode === 'jam' ? 'âˆ' : `${state.dailyPoolLeft}/${state.dailyPoolMax}`;

    const w = state.weather;
    document.getElementById('ui-weather-icon').innerText = CONFIG.weather.icons[w];
    let eff = CONFIG.weather.eff[w] * 100;
    
    const forced = state.activeBuffs.find(b => b.type === 'forcedWeather');
    const boosted = state.activeBuffs.find(b => b.type === 'solarEfficiency');
    if (boosted) eff *= boosted.val;

    document.getElementById('ui-weather-eff').innerText = `PV:${eff.toFixed(0)}%${forced ? '(é”å®š)' : ''}`;
    let effColor = 'text-slate-500';
    if(w === 'rainy' || w === 'stormy') effColor = 'text-red-500';
    if(boosted) effColor = 'text-green-600 font-black'; 
    document.getElementById('ui-weather-eff').className = `text-[8px] font-bold ${effColor} whitespace-nowrap`;

    let forecastW = state.forecast;
    if (forced && forced.daysLeft > 1) forecastW = forced.val;
    const fIcon = CONFIG.weather.icons[forecastW];
    document.getElementById('ui-forecast').innerText = `æ˜:${fIcon}`;

    let gp = CITY_CONFIG[state.settings.city].prices[state.hour];
    if (state.settings.mode === 'collapse') { if (state.hour >= 6 && state.hour < 18) gp = 10.0; else gp = 0.2; }
    if (state.settings.mode === 'offgrid') gp = state.price; 
    const discountBuff = state.activeBuffs.find(b => b.type === 'gridDiscount');
    if (discountBuff) gp *= discountBuff.val;
    const gpMult = state.activeBuffs.find(b => b.type === 'gridPriceMult');
    if (gpMult) gp *= gpMult.val;

    const gpEl = document.getElementById('ui-grid-price');
    gpEl.innerText = `$${gp.toFixed(2)}`;
    gpEl.className = `font-mono font-bold text-lg ${gp>=1.5 ? 'text-red-500' : 'text-slate-700'}`;

    const d = state.lastTickData;
    document.getElementById('ui-load-text').innerText = `${d.load.toFixed(1)} / ${d.limit} kW`;
    
    const base = d.limit > 0 ? d.limit : 1;
    const pSolar = (d.solar / base) * 100;
    const pBatt = (d.batt / base) * 100;
    const pGrid = (d.grid / base) * 100;

    document.getElementById('bar-solar').style.width = `${pSolar}%`;
    document.getElementById('bar-batt').style.width = `${pBatt}%`;
    document.getElementById('bar-grid').style.width = `${pGrid}%`;
    
    const battBar = document.getElementById('bar-batt');
    if (d.battAction === 'charge') battBar.innerText = 'âš¡';
    else if (d.battAction === 'discharge') battBar.innerText = 'ğŸ”‹';
    else battBar.innerText = '';

    const overloadMsg = document.getElementById('ui-overload-msg');
    const powerMonitor = document.getElementById('power-monitor');
    if (d.reqLoad > d.limit) {
        overloadMsg.classList.remove('hidden');
        powerMonitor.classList.add('warning-pulse', 'border-red-400');
    } else {
        overloadMsg.classList.add('hidden');
        powerMonitor.classList.remove('warning-pulse', 'border-red-400');
    }

    document.getElementById('count-slow').innerText = state.assets.slowCharger;
    document.getElementById('count-fast').innerText = state.assets.fastCharger;
    document.getElementById('count-solar').innerText = state.assets.solar;
    document.getElementById('count-battery').innerText = state.assets.battery;
    document.getElementById('count-transformer').innerText = state.assets.transformer;
    
    const updateCostDisplay = (type, elId) => {
        const raw = state.currentCosts[type];
        const actual = getAssetCost(type);
        const el = document.getElementById(elId);
        if (actual < raw) {
            el.innerHTML = `<span class="opacity-50 line-through text-[8px] mr-1">$${raw}</span><span>$${actual}</span>`;
        } else {
            el.innerText = `$${raw}`;
        }
    };

    updateCostDisplay('slowCharger', 'cost-slow');
    updateCostDisplay('fastCharger', 'cost-fast');
    updateCostDisplay('transformer', 'cost-transformer');
    updateCostDisplay('solar', 'cost-solar');
    updateCostDisplay('battery', 'cost-battery');
    updateCostDisplay('marketing', 'cost-marketing');

    const buffBar = document.getElementById('ui-buff-bar');
    if (state.activeBuffs.length > 0) {
        buffBar.classList.remove('hidden');
        const uniqueBuffs = [];
        const seen = new Set();
        state.activeBuffs.forEach(b => {
            if(!seen.has(b.name)) { uniqueBuffs.push(b); seen.add(b.name); }
        });
        buffBar.innerHTML = uniqueBuffs.map(b => `
            <div class="flex items-center gap-1 bg-indigo-50 border border-indigo-200 px-2 py-0.5 rounded-full shrink-0">
                <span class="text-xs">${b.icon}</span>
                <span class="text-[9px] font-bold text-indigo-700">${b.name} ${b.daysLeft}d</span>
            </div>
        `).join('');
    } else {
        buffBar.classList.add('hidden');
    }

    const speedLabel = document.getElementById('ui-speed-label');
    if (state.paused) {
        speedLabel.innerText = "PAUSED";
        speedLabel.className = "text-[10px] text-slate-400 font-bold animate-pulse";
    } else {
        const ms = state.gameSpeed;
        const txt = ms===500?"1x":ms===125?"4x":"8x";
        speedLabel.innerText = "> " + txt;
        speedLabel.className = "text-[10px] text-green-600 font-bold";
    }
}

function resizeCanvas() {
    const wrapper = document.getElementById('canvas-wrapper');
    const dpr = window.devicePixelRatio || 1;
    
    const totalChargers = state.assets.slowCharger + state.assets.fastCharger;
    const cols = 5; 
    const rows = Math.ceil(totalChargers / cols);
    const minHeight = 400;
    const requiredHeight = 110 + (rows * 85); 
    const displayHeight = Math.max(minHeight, requiredHeight);
    
    const rect = wrapper.getBoundingClientRect();
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    
    ctx.setTransform(1, 0, 0, 1, 0, 0); 
    ctx.scale(dpr, dpr);
    canvasWidth = rect.width;
    canvasHeight = rect.height;
    
    if (ctx.roundRect === undefined) ctx.roundRect = function(x, y, w, h, r) { this.rect(x,y,w,h); };
    if (myChart) myChart.resize();
    draw();
}
window.addEventListener('resize', resizeCanvas);

function draw() {
    if (!canvasWidth) return;
    if (!weatherSystem.init) initWeatherSystem(canvasWidth, canvasHeight);
    ctx.clearRect(0, 0, canvasWidth, canvasHeight);
    
    const h = state.hour;
    const w = state.weather;
    let bgGrad = ctx.createLinearGradient(0, 0, 0, canvasHeight);
    
    if (h < 6 || h >= 19) {
        bgGrad.addColorStop(0, '#0f172a'); bgGrad.addColorStop(1, '#020617');
    } else {
        if (w === 'sunny') { bgGrad.addColorStop(0, '#38bdf8'); bgGrad.addColorStop(1, '#bae6fd'); } 
        else if (w === 'cloudy') { bgGrad.addColorStop(0, '#94a3b8'); bgGrad.addColorStop(1, '#e2e8f0'); } 
        else if (w === 'rainy') { bgGrad.addColorStop(0, '#475569'); bgGrad.addColorStop(1, '#64748b'); }
    }
    ctx.fillStyle = bgGrad;
    ctx.fillRect(0, 0, canvasWidth, canvasHeight);

    const celestialX = canvasWidth - 60;
    const celestialY = 60;
    
    if (h < 6 || h >= 19) {
        ctx.fillStyle = '#fefce8'; ctx.shadowColor = '#fefce8'; ctx.shadowBlur = 20;
        ctx.beginPath(); ctx.arc(celestialX, celestialY, 25, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0; 
        ctx.fillStyle = 'rgba(200,200,200,0.2)';
        ctx.beginPath(); ctx.arc(celestialX-8, celestialY-5, 6, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(celestialX+10, celestialY+8, 4, 0, Math.PI*2); ctx.fill();
    } else {
        if (w !== 'rainy') {
            if (w === 'sunny') {
                weatherSystem.sunAngle += 0.005;
                ctx.save();
                ctx.translate(celestialX, celestialY);
                ctx.rotate(weatherSystem.sunAngle);
                ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
                for(let i=0; i<8; i++) {
                    ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(-10, -80); ctx.lineTo(10, -80); ctx.fill(); ctx.rotate(Math.PI / 4);
                }
                ctx.restore();
            }
            ctx.fillStyle = '#fbbf24'; 
            if (w === 'sunny') { ctx.shadowColor = '#fbbf24'; ctx.shadowBlur = 40; }
            ctx.beginPath(); ctx.arc(celestialX, celestialY, 30, 0, Math.PI*2); ctx.fill();
            ctx.shadowBlur = 0;
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            ctx.beginPath(); ctx.arc(celestialX-10, celestialY-10, 8, 0, Math.PI*2); ctx.fill();
        }
    }

    if (w === 'cloudy' || w === 'rainy') {
        const cloudColor = w === 'rainy' ? 'rgba(51, 65, 85, 0.8)' : 'rgba(255, 255, 255, 0.6)';
        weatherSystem.clouds.forEach(cloud => {
            cloud.x += cloud.speed;
            if (cloud.x > canvasWidth + 100) cloud.x = -100;
            ctx.fillStyle = cloudColor;
            ctx.beginPath();
            const cx = cloud.x; const cy = cloud.y; const s = cloud.scale;
            ctx.arc(cx, cy, 30*s, 0, Math.PI * 2); 
            ctx.arc(cx + 40*s, cy - 10*s, 35*s, 0, Math.PI * 2);
            ctx.arc(cx + 80*s, cy + 5*s, 28*s, 0, Math.PI * 2);
            ctx.fill();
        });
    }

    if (w === 'rainy') {
        ctx.strokeStyle = 'rgba(203, 213, 225, 0.6)';
        ctx.lineWidth = 1.5;
        weatherSystem.rainDrops.forEach(drop => {
            drop.y += drop.speed;
            drop.x -= 1; 
            if (drop.y > canvasHeight) { drop.y = -20; drop.x = Math.random() * canvasWidth; }
            ctx.beginPath(); ctx.moveTo(drop.x, drop.y); ctx.lineTo(drop.x - 2, drop.y + drop.len); ctx.stroke();
            if (drop.y > canvasHeight - 50 && Math.random() > 0.8) {
                ctx.fillStyle = 'rgba(255,255,255,0.5)';
                ctx.beginPath(); ctx.ellipse(drop.x, canvasHeight-10, 5, 2, 0, 0, Math.PI*2); ctx.fill();
            }
        });
    }
    
    drawHub(10, 10); 
    drawChargers();
}

function drawHub(x, y) {
    ctx.fillStyle = '#64748b'; ctx.font = 'bold 10px sans-serif';
    ctx.fillText(CITY_CONFIG[state.settings.city].name + ' Â· èƒ½æºä¸­å¿ƒ', x + 10, y + 5); 

    const eff = (state.hour >= 6 && state.hour <= 18) ? Math.sin((state.hour-6)/12*Math.PI) : 0;
    let weatherEff = CONFIG.weather.eff[state.weather];
    const forced = state.activeBuffs.find(b => b.type === 'forcedWeather');
    const boosted = state.activeBuffs.find(b => b.type === 'solarEfficiency');
    if(forced) weatherEff = CONFIG.weather.eff[forced.val];
    if(boosted) weatherEff *= boosted.val;
    
    ctx.fillStyle = '#eab308'; 
    ctx.fillText(`å…‰ä¼ ${state.assets.solar}`, x+10, y+25); 
    ctx.fillStyle = '#fef08a'; ctx.fillRect(x+10, y+30, 60, 3); 
    
    const badWeathers = ['rainy', 'stormy', 'snowy', 'foggy', 'sandstorm', 'acid_rain', 'smog'];
    if (badWeathers.includes(state.weather)) ctx.fillStyle = '#94a3b8'; 
    else if (boosted) ctx.fillStyle = '#ea580c'; 
    else ctx.fillStyle = '#eab308'; 

    const barWidth = 60 * eff * weatherEff;
    ctx.fillRect(x+10, y+30, Math.min(60, barWidth), 3); 
    if (barWidth > 60) { ctx.fillStyle = '#ef4444'; ctx.fillRect(x+70, y+28, 4, 7); } 

    const max = state.assets.battery * CONFIG.batteryCap;
    const pct = max > 0 ? state.batteryKwh/max : 0;
    ctx.fillStyle = '#22c55e';
    ctx.fillText(`å‚¨èƒ½ ${state.assets.battery}`, x+100, y+25); 
    ctx.strokeStyle = '#64748b'; ctx.lineWidth=1; 
    ctx.strokeRect(x+100, y+30, 30, 7); 
    ctx.fillRect(x+132, y+32, 2, 3); 
    
    ctx.fillStyle = pct<0.2 ? '#ef4444' : '#22c55e';
    ctx.fillRect(x+101, y+31, 28*pct, 5); 
    ctx.fillStyle = '#64748b'; ctx.font='8px sans-serif'; 
    ctx.fillText(max>0 ? `${state.batteryKwh.toFixed(0)}/${max}` : '', x+140, y+36); 
}

function drawChargers() {
    const startX = 20;
    const startY = 70; 
    const gapX = 35; 
    const gapY = 55; 
    
    const cols = Math.floor((canvasWidth - 40) / gapX); 

    const render = (type, idx, absIdx) => {
        const col = absIdx % cols;
        const row = Math.floor(absIdx / cols);
        const x = startX + col * gapX;
        const y = startY + row * gapY;

        ctx.fillStyle = 'rgba(0,0,0,0.05)';
        ctx.beginPath(); ctx.ellipse(x+11, y+38, 10, 4, 0, 0, Math.PI*2); ctx.fill();
        
        ctx.fillStyle = '#fff'; ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 1.5;
        ctx.fillRect(x, y, 22, 36); ctx.strokeRect(x, y, 22, 36);
        
        ctx.fillStyle = type === 'slow' ? '#3b82f6' : '#a855f7';
        ctx.fillRect(x+2, y+2, 18, 3);

        const car = state.cars.find(c => c.type === type && c.slot === idx);
        if (car) {
            ctx.font = '16px sans-serif'; 
            ctx.textAlign = 'center';
            ctx.fillStyle = '#000'; 
            ctx.fillText(car.emoji, x+11, y+26); 
            ctx.textAlign = 'start'; 

            const pct = Math.min(1, car.kwhReceived / car.kwhNeeded);
            ctx.fillStyle = '#374151'; ctx.fillRect(x-2, y+30, 26, 3); 
            ctx.fillStyle = '#4ade80'; ctx.fillRect(x-2, y+30, 26 * pct, 3);
            
            if (!state.paused) {
                ctx.strokeStyle = '#22c55e'; ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(x+11, y+10); ctx.lineTo(x+11, y+18); ctx.stroke();
            }
        } else {
            ctx.fillStyle = '#cbd5e1'; ctx.font = '8px sans-serif';
            ctx.textAlign = 'center'; ctx.fillText('ç©º', x+11, y+22); ctx.textAlign = 'start';
        }
    };
    
    let count = 0;
    for (let i = 0; i < state.assets.slowCharger; i++) render('slow', i, count++);
    for (let i = 0; i < state.assets.fastCharger; i++) render('fast', i, count++);
}

function closeEventModal() {
    closeModal('event-modal'); 
    checkEndGame();
    if (state.money >= 0) setSpeed(state.lastGameSpeed); 
}

function showBillModal() {
    const balance = state.money;
    const rent = state.pendingRent;
    const final = balance - rent;

    document.getElementById('bill-balance').innerText = `$${balance.toFixed(2)}`;
    document.getElementById('bill-rent').innerText = `-$${rent.toFixed(2)}`;
    document.getElementById('bill-final').innerText = `$${final.toFixed(2)}`;
    
    const finalEl = document.getElementById('bill-final');
    if (final < 0) finalEl.className = "font-mono font-bold text-red-600";
    else finalEl.className = "font-mono font-bold text-green-600";

    openModal('bill-modal'); 
}

function payBill() {
    state.money -= state.pendingRent;
    state.pendingRent = 0;
    state.weeksSurvived++; 
    closeModal('bill-modal');
    if (checkEndGame()) return;
    if (state.money >= 0) setSpeed(state.lastGameSpeed); 
}

function updatePrice(v) {
    state.price = parseFloat(v);
    document.getElementById('price-display').innerText = `$${state.price.toFixed(2)}`;
}

function adjustPrice(delta) {
    let newVal = state.price + delta;
    newVal = Math.max(0.5, Math.min(3.0, newVal));
    newVal = Math.round(newVal * 10) / 10;
    updatePrice(newVal);
    const slider = document.getElementById('price-slider');
    if (slider) slider.value = newVal;
}

function setSpeed(ms) {
    document.querySelectorAll('.speed-btn').forEach(btn => {
        btn.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
        btn.classList.add('text-slate-500');
    });
    let activeId = '';
    if(ms === 0) activeId = 'speed-0';
    else if(ms === 500) activeId = 'speed-1';
    else if(ms === 125) activeId = 'speed-4';
    else if(ms === 62.5) activeId = 'speed-8';
    
    if(activeId) {
        const speedBtn = document.getElementById(activeId);
        if (speedBtn) {
            speedBtn.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
            speedBtn.classList.remove('text-slate-500');
        }
    }

    if (ms === 0) {
        state.paused = true;
        clearTimeout(state.timer);
    } else {
        state.gameSpeed = ms;
        state.lastGameSpeed = ms;
        if (state.paused && modalOpenCount === 0) {
            state.paused = false;
            tick();
        }
    }
    updateUI();
}

// åŠ è½½å·²è§£é”çš„å…³å¡
function loadUnlockedLevels() {
    const saved = localStorage.getItem('ev_tycoon_unlocked_levels');
    if (saved) {
        unlockedLevels = JSON.parse(saved);
    } else {
        // é»˜è®¤è§£é”ç¬¬ä¸€å…³
        unlockedLevels = [1];
    }
}

// ä¿å­˜å·²è§£é”çš„å…³å¡
function saveUnlockedLevels() {
    localStorage.setItem('ev_tycoon_unlocked_levels', JSON.stringify(unlockedLevels));
}

// è§£é”æ–°å…³å¡
function unlockLevel(level) {
    if (!unlockedLevels.includes(level)) {
        unlockedLevels.push(level);
        saveUnlockedLevels();
    }
}

// æ£€æŸ¥å…³å¡æ˜¯å¦å·²è§£é”
function isLevelUnlocked(level) {
    return unlockedLevels.includes(level);
}

// æ›´æ–°å…³å¡é€‰æ‹©ç•Œé¢çš„æ˜¾ç¤ºçŠ¶æ€
function updateLevelSelectUI() {
    // æ£€æŸ¥æ¯ä¸ªå…³å¡çš„è§£é”çŠ¶æ€å¹¶æ›´æ–°UI
    for (let i = 1; i <= 4; i++) {
        const levelCard = document.querySelector(`[onclick="selectLevel(${i})"]`);
        if (levelCard) {
            if (isLevelUnlocked(i)) {
                levelCard.classList.remove('opacity-50', 'cursor-not-allowed');
                levelCard.style.pointerEvents = 'auto';
            } else {
                levelCard.classList.add('opacity-50', 'cursor-not-allowed');
                levelCard.style.pointerEvents = 'none';
            }
        }
    }
}

// åˆå§‹åŒ–æ¸¸æˆ
loadUnlockedLevels();
updateLevelSelectUI();

// åˆå§‹çŠ¶æ€è®¾ç½®ä¸ºæš‚åœ
state.paused = true;

// ç¡®ä¿æ¸¸æˆä¸»ç•Œé¢éšè—
document.getElementById('game-main-container').classList.add('hidden');

// ç¡®ä¿æ‰“å¼€å…³å¡é€‰æ‹©ç•Œé¢
console.log('Opening level select modal');
openModal('level-select-modal');

// ç¡®ä¿å…¶ä»–æ¨¡æ€æ¡†æ˜¯å…³é—­çš„
closeModal('start-modal');
</script>
</body>
</html>